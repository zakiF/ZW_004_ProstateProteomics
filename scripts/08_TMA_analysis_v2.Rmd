---
title: "TMA analysis"
date: "2025-09-10"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: true
    toc_depth: 3
    number_sections: false
    theme: lumen
---

# Background


# Objectives


# Conclusion


# Pre-processing 

## Loading packages

```{r, message=FALSE, warning=FALSE}
library(here)
library(tidyverse)
library(readxl)   
library(readr)
library(stringr)
library(ggplot2)
library(DescTools)

# Install additional packages if needed
if(!require(effsize, quietly = TRUE)) {
  cat("Note: Installing effsize package for effect size calculations...\n")
  install.packages("effsize")
  library(effsize)
}

if(!require(gridExtra, quietly = TRUE)) {
  cat("Note: Installing gridExtra package for plot arrangements...\n")
  install.packages("gridExtra")
  library(gridExtra)
}

if(!require(ggsignif, quietly = TRUE)) {
  cat("Note: Installing ggsignif package for significance annotations...\n")
  install.packages("ggsignif")
  library(ggsignif)
}

if(!require(DescTools, quietly = TRUE)) {
  cat("Note: Installing DescTools package for Cochran-Armitage trend test...\n")
  install.packages("DescTools")
  library(DescTools)
}

```

## Directories

```{r}
wd <- list()
wd$main <- here()
wd$data <- file.path(wd$main, "data")
wd$tma <- file.path(wd$data, "mayo_image")
wd$output <- file.path(wd$main, "output")
wd$script <- file.path(wd$main, "scripts")

wd$outData <- file.path(wd$output, "data")
wd$outCurr <- file.path(wd$output, "08_TMA_analysis")
```


Create directories

```{r}
if (!file.exists(wd$outCurr)) {
  dir.create(wd$outCurr)
} else {
  print("Directory already exists")
}
```

Load functions

```{r}
source(file.path(wd$script, "functions.R"))
```


# Obj 1: Reformat TMA

We reformat the TMA data.

```{r}
dat_tma <- read_xlsx(file.path(wd$tma, "CD138 CD276 GDF15 TROP2.xlsx"))

# Examine the structure of the data
cat("=== TMA Data Structure ===\n")
cat("Dimensions:", nrow(dat_tma), "rows x", ncol(dat_tma), "columns\n")
cat("Column names:\n")
print(colnames(dat_tma))

# Look for the relevant columns mentioned in the comments
cat("\n=== Key Columns for Analysis ===\n")
relevant_cols <- colnames(dat_tma)[grepl("Days after CRPC|CD138|CD276|GDF15|TROP2", colnames(dat_tma))]
print(relevant_cols)

# Show first few rows to understand data structure
cat("\n=== First 5 rows of relevant data ===\n")
print(head(dat_tma[, relevant_cols], 5))
```

Lets understand the sheet and extract the values. We do it one TMA at a time.

## Met site 1

The column CD138 MET1, CD276 MET1, GDF15 MET1 and TROP2 MET1 are the TMA result for the first biopsy. If the values in 'Days after CRPC...49' is positive, then the sample is mCRPC if its negative its mCRPC


```{r}
# Extract Met site 1 data
df_met1 <- dat_tma %>% 
  select(contains('Days after CRPC...49') | contains('CD138 MET1') | 
         contains('CD276 MET1') | contains('GDF15 MET1') | contains('TROP2 MET1'),
         contains('Metastatic Organ Met 1')) %>%
  # Remove rows where all TMA values are NA
  filter(!is.na(`CD138 MET1`) | !is.na(`CD276 MET1`) | 
         !is.na(`GDF15 MET1`) | !is.na(`TROP2 MET1`)) %>%
  mutate(
    # Label as mCRPC or mHSPC based on days after CRPC
    # Positive = mCRPC, Negative = mHSPC
    disease_stage = ifelse(`Days after CRPC...49` > 0, "mCRPC", "mHSPC"),
    # Add site identifier
    biopsy_site = "MET1",
    # Add patient ID if available (assuming first column or row identifier)
    patient_id = row_number()
  ) %>%
  # Rename columns for consistency
  rename(
    days_after_crpc = `Days after CRPC...49`,
    CD138 = `CD138 MET1`,
    CD276 = `CD276 MET1`, 
    GDF15 = `GDF15 MET1`,
    TROP2 = `TROP2 MET1`,
    organ = 'Metastatic Organ Met 1'
  ) %>%
  # Reorder columns
  select(patient_id, biopsy_site, disease_stage, organ, days_after_crpc, CD138, CD276, GDF15, TROP2)

cat("=== Met Site 1 Results ===\n")
cat("Number of samples:", nrow(df_met1), "\n")
cat("Disease stage distribution:\n")
print(table(df_met1$disease_stage, useNA = "ifany"))
cat("\nFirst 5 rows:\n")
print(head(df_met1, 5))
```


## Met site 2

We follow the same logic, now using 'Days after CRPC...63' values and : CD138 MET2, CD276 MET2, GDF15 MET2, TROP2 MET2

```{r}
# Extract Met site 2 data
df_met2 <- dat_tma %>% 
  select(contains('Days after CRPC...63') | contains('CD138 MET2') | 
         contains('CD276 MET2') | contains('GDF15 MET2') | contains('TROP2 MET2'),
         contains('Metastatic organ Met 2')) %>%
  # Remove rows where all TMA values are NA
  filter(!is.na(`CD138 MET2`) | !is.na(`CD276 MET2`) | 
         !is.na(`GDF15 MET2`) | !is.na(`TROP2 MET2`)) %>%
  mutate(
    # Label as mCRPC or mHSPC based on days after CRPC
    # Positive = mCRPC, Negative = mHSPC
    disease_stage = ifelse(`Days after CRPC...63` > 0, "mCRPC", "mHSPC"),
    # Add site identifier
    biopsy_site = "MET2",
    # Add patient ID if available (assuming first column or row identifier)
    patient_id = row_number()
  ) %>%
  # Rename columns for consistency
  rename(
    days_after_crpc = `Days after CRPC...63`,
    CD138 = `CD138 MET2`,
    CD276 = `CD276 MET2`, 
    GDF15 = `GDF15 MET2`,
    TROP2 = `TROP2 MET2`,
    organ = 'Metastatic organ Met 2'
  ) %>%
  # Reorder columns
  select(patient_id, biopsy_site, disease_stage, organ, days_after_crpc, CD138, CD276, GDF15, TROP2)

cat("=== Met Site 2 Results ===\n")
cat("Number of samples:", nrow(df_met2), "\n")
cat("Disease stage distribution:\n")
print(table(df_met2$disease_stage, useNA = "ifany"))
cat("\nFirst 5 rows:\n")
print(head(df_met2, 5))
```


## Met site 3

All here are mCRPC. Read the values of CD138 MET3, CD276 MET3, GDF15 MET3, TROP2 MET3

```{r}
# Extract Met site 3 data
df_met3 <- dat_tma %>% 
  select(contains('CD138 MET3') | contains('CD276 MET3') | 
         contains('GDF15 MET3') | contains('TROP2 MET3'),
         contains('Metastatic organ Met 3')) %>%
  # Remove rows where all TMA values are NA
  filter(!is.na(`CD138 MET3`) | !is.na(`CD276 MET3`) | 
         !is.na(`GDF15 MET3`) | !is.na(`TROP2 MET3`)) %>%
  mutate(
    # All MET3 samples are mCRPC as stated
    disease_stage = "mCRPC",
    # Add site identifier
    biopsy_site = "MET3",
    # Add patient ID 
    patient_id = row_number(),
    # No days after CRPC data for MET3, set to NA
    days_after_crpc = NA_real_
  ) %>%
  # Rename columns for consistency
  rename(
    CD138 = `CD138 MET3`,
    CD276 = `CD276 MET3`, 
    GDF15 = `GDF15 MET3`,
    TROP2 = `TROP2 MET3`,
    organ = 'Metastatic organ Met 3'
  ) %>%
  # Reorder columns to match other datasets
  select(patient_id, biopsy_site, disease_stage, organ, days_after_crpc, CD138, CD276, GDF15, TROP2)

cat("=== Met Site 3 Results ===\n")
cat("Number of samples:", nrow(df_met3), "\n")
cat("Disease stage distribution:\n")
print(table(df_met3$disease_stage, useNA = "ifany"))
cat("\nFirst 5 rows:\n")
print(head(df_met3, 5))
```


## Primary site (PRIM)

These are the primary prostate samples. All are considered as mHSPC. Read in the value of CD138 PRIM, CD276 PRIM, GDF15 PRIM, TROP2 PRIM

```{r}
# Extract Primary site data
df_prim <- dat_tma %>% 
  select(contains('CD138 PRIM') | contains('CD276 PRIM') | 
         contains('GDF15 PRIM') | contains('TROP2 PRIM')) %>%
  # Remove rows where all TMA values are NA
  filter(!is.na(`CD138 PRIM`) | !is.na(`CD276 PRIM`) | 
         !is.na(`GDF15 PRIM`) | !is.na(`TROP2 PRIM`)) %>%
  mutate(
    # All primary samples are mHSPC as stated
    disease_stage = "Local",
    # Add site identifier
    biopsy_site = "PRIM",
    # Add patient ID 
    patient_id = row_number(),
    # No days after CRPC data for primary samples, set to NA
    days_after_crpc = NA_real_,
    organ = "local"
  ) %>%
  # Rename columns for consistency
  rename(
    CD138 = `CD138 PRIM`,
    CD276 = `CD276 PRIM`, 
    GDF15 = `GDF15 PRIM`,
    TROP2 = `TROP2 PRIM`,
  ) %>%
  # Reorder columns to match other datasets
  select(patient_id, biopsy_site, disease_stage, organ, days_after_crpc, CD138, CD276, GDF15, TROP2)

cat("=== Primary Site Results ===\n")
cat("Number of samples:", nrow(df_prim), "\n")
cat("Disease stage distribution:\n")
print(table(df_prim$disease_stage, useNA = "ifany"))
cat("\nFirst 5 rows:\n")
print(head(df_prim, 5))
```

# Obj 2: Combine All TMA Results

Now we combine all the TMA results from different biopsy sites into one comprehensive data frame.

**Note on NT (No Tumor) Values**: 
- NT values indicate "no tumor" in the TMA sample
- These are converted to -1 to distinguish from missing data (NA) and valid tumor scores (≥0)  
- In future analyses, you can easily exclude NT samples by filtering for values ≥ 0
- Summary statistics are calculated excluding NT values to reflect only tumor-containing samples

```{r}
# Function to clean TMA marker data
clean_tma_markers <- function(df) {
  df %>%
    mutate(
      # Convert NT (no tumor) to -1 and convert to numeric
      CD138 = case_when(
        CD138 == "NT" ~ -1,
        TRUE ~ as.numeric(CD138)
      ),
      CD276 = case_when(
        CD276 == "NT" ~ -1,
        TRUE ~ as.numeric(CD276)
      ),
      GDF15 = case_when(
        GDF15 == "NT" ~ -1,
        TRUE ~ as.numeric(GDF15)
      ),
      TROP2 = case_when(
        TROP2 == "NT" ~ -1,
        TRUE ~ as.numeric(TROP2)
      )
    )
}

# Clean all individual datasets first
df_met1_clean <- clean_tma_markers(df_met1)
df_met2_clean <- clean_tma_markers(df_met2)  
df_met3_clean <- clean_tma_markers(df_met3)
df_prim_clean <- clean_tma_markers(df_prim)

# Now combine the cleaned datasets
df_tma_combined <- bind_rows(df_met1_clean, df_met2_clean, df_met3_clean, df_prim_clean) %>%
  # Create a unique sample ID combining patient_id and biopsy_site
  mutate(
    sample_id = paste(patient_id, biopsy_site, sep = "_"),
    # Convert biopsy_site to factor with meaningful order
    biopsy_site = factor(biopsy_site, levels = c("PRIM", "MET1", "MET2", "MET3")),
    # Convert disease_stage to factor
    disease_stage = factor(disease_stage, levels = c("Local", "mHSPC", "mCRPC"))
  ) %>%
  # Reorder columns for final output
  select(sample_id, patient_id, biopsy_site, disease_stage, organ, days_after_crpc, 
         CD138, CD276, GDF15, TROP2)

# Show how many NT values were converted to -1
cat("=== NT (No Tumor) Value Conversion Summary ===\n")
markers <- c("CD138", "CD276", "GDF15", "TROP2")
for(marker in markers) {
  nt_count <- sum(df_tma_combined[[marker]] == -1, na.rm = TRUE)
  cat(marker, "- NT values converted to -1:", nt_count, "\n")
}

cat("=== Combined TMA Results Summary ===\n")
cat("Total samples:", nrow(df_tma_combined), "\n")
cat("Samples by biopsy site:\n")
print(table(df_tma_combined$biopsy_site, useNA = "ifany"))
cat("\nSamples by disease stage:\n")
print(table(df_tma_combined$disease_stage, useNA = "ifany"))
cat("\nSamples by site and disease stage:\n")
print(table(df_tma_combined$biopsy_site, df_tma_combined$disease_stage, useNA = "ifany"))

# Show summary statistics for each protein marker
cat("\n=== Protein Marker Summary ===\n")
markers <- c("CD138", "CD276", "GDF15", "TROP2")
for(marker in markers) {
  cat("\n", marker, ":\n")
  
  # Count different value types
  non_missing <- sum(!is.na(df_tma_combined[[marker]]))
  nt_values <- sum(df_tma_combined[[marker]] == -1, na.rm = TRUE)
  valid_tumor <- sum(df_tma_combined[[marker]] >= 0, na.rm = TRUE)
  
  cat("  Non-missing values:", non_missing, "\n")
  cat("  NT (no tumor) values (-1):", nt_values, "\n")
  cat("  Valid tumor values (≥0):", valid_tumor, "\n")
  
  # Statistics excluding NT values
  valid_data <- df_tma_combined[[marker]][df_tma_combined[[marker]] >= 0 & !is.na(df_tma_combined[[marker]])]
  if(length(valid_data) > 0) {
    cat("  Range (excluding NT):", paste(range(valid_data), collapse = " - "), "\n")
    cat("  Mean (SD, excluding NT):", round(mean(valid_data), 2), 
        "(", round(sd(valid_data), 2), ")\n")
  } else {
    cat("  No valid tumor data available\n")
  }
}

cat("\n=== First 10 rows of combined dataset ===\n")
print(head(df_tma_combined, 10))
```

## Save Results

Save the combined TMA results for further analysis.

```{r}
# Save the combined dataset
write.csv(df_tma_combined, 
          file.path(wd$outCurr, "TMA_combined_results.csv"), 
          row.names = FALSE)

# Also save individual datasets for reference
write.csv(df_met1, file.path(wd$outCurr, "TMA_MET1_results.csv"), row.names = FALSE)
write.csv(df_met2, file.path(wd$outCurr, "TMA_MET2_results.csv"), row.names = FALSE)
write.csv(df_met3, file.path(wd$outCurr, "TMA_MET3_results.csv"), row.names = FALSE)
write.csv(df_prim, file.path(wd$outCurr, "TMA_PRIM_results.csv"), row.names = FALSE)

cat("=== Files Saved ===\n")
cat("Combined results:", file.path(wd$outCurr, "TMA_combined_results.csv"), "\n")
cat("Individual site files saved in:", wd$outCurr, "\n")

# Create a summary report
summary_stats <- df_tma_combined %>%
  group_by(biopsy_site, disease_stage) %>%
  summarise(
    n_samples = n(),
    n_nt_samples = sum(CD138 == -1 | CD276 == -1 | GDF15 == -1 | TROP2 == -1, na.rm = TRUE),
    # Calculate means excluding NT values (-1)
    CD138_mean = round(mean(CD138[CD138 >= 0], na.rm = TRUE), 2),
    CD276_mean = round(mean(CD276[CD276 >= 0], na.rm = TRUE), 2),
    GDF15_mean = round(mean(GDF15[GDF15 >= 0], na.rm = TRUE), 2),
    TROP2_mean = round(mean(TROP2[TROP2 >= 0], na.rm = TRUE), 2),
    # Count valid tumor samples for each marker
    CD138_n_valid = sum(CD138 >= 0, na.rm = TRUE),
    CD276_n_valid = sum(CD276 >= 0, na.rm = TRUE),
    GDF15_n_valid = sum(GDF15 >= 0, na.rm = TRUE),
    TROP2_n_valid = sum(TROP2 >= 0, na.rm = TRUE),
    .groups = "drop"
  )

write.csv(summary_stats, 
          file.path(wd$outCurr, "TMA_summary_by_site_stage.csv"), 
          row.names = FALSE)

cat("Summary statistics saved:", file.path(wd$outCurr, "TMA_summary_by_site_stage.csv"), "\n")
print(summary_stats)
```

# Obj 3: Compare mHSPC vs mCRPC Marker Expression

Compare TMA marker scores between disease stages, excluding NT (-1) values.

```{r}
# Create dataset for statistical analysis (exclude NT values)
df_analysis <- df_tma_combined %>%
  filter(CD138 >= 0 | CD276 >= 0 | GDF15 >= 0 | TROP2 >= 0) %>%  # At least one valid marker
  filter(!is.na(disease_stage))  # Remove samples with missing disease stage

cat("=== Analysis Dataset ===\n")
cat("Total samples for analysis:", nrow(df_analysis), "\n")
cat("Disease stage distribution:\n")
print(table(df_analysis$disease_stage))

# Function to perform statistical tests for ordinal data (0-3 scale)
compare_markers <- function(data, marker_name) {
  
  cat("\n=== Analysis for", marker_name, "===\n")
  
  # Get valid data (excluding NT values)
  valid_data <- data %>%
    filter(get(marker_name) >= 0, !is.na(get(marker_name)), !is.na(disease_stage))
  
  if(nrow(valid_data) == 0) {
    cat("No valid data for", marker_name, "\n")
    return(NULL)
  }
  
  cat("Valid samples:", nrow(valid_data), "\n")
  
  # Summary statistics by group
  summary_stats <- valid_data %>%
    group_by(disease_stage) %>%
    summarise(
      n = n(),
      mean = round(mean(get(marker_name)), 2),
      median = median(get(marker_name)),
      sd = round(sd(get(marker_name)), 2),
      min = min(get(marker_name)),
      max = max(get(marker_name)),
      .groups = "drop"
    )
  
  print(summary_stats)
  
  # Cross-tabulation of scores by disease stage
  cat("\nScore distribution by disease stage:\n")
  cross_tab <- table(valid_data$disease_stage, valid_data[[marker_name]])
  print(cross_tab)
  
  # Statistical tests
  local_scores <- valid_data[[marker_name]][valid_data$disease_stage == "Local"]
  mhspc_scores <- valid_data[[marker_name]][valid_data$disease_stage == "mHSPC"]
  mcrpc_scores <- valid_data[[marker_name]][valid_data$disease_stage == "mCRPC"]

  # Mann-Whitney U test (Wilcoxon rank-sum) - best for ordinal data
  # Compare Local vs mCRPC if both exist
  if(length(local_scores) > 0 & length(mcrpc_scores) > 0) {
    wilcox_test <- wilcox.test(local_scores, mcrpc_scores)
    cat("\nMann-Whitney U test (Local vs mCRPC) p-value:", round(wilcox_test$p.value, 4), "\n")
  }
  # Also compare mHSPC vs mCRPC if both exist
  if(length(mhspc_scores) > 0 & length(mcrpc_scores) > 0) {
    wilcox_test <- wilcox.test(mhspc_scores, mcrpc_scores)
    cat("\nMann-Whitney U test (mHSPC vs mCRPC) p-value:", round(wilcox_test$p.value, 4), "\n")
    
    # Chi-square test for independence (if sufficient sample size)
    if(min(cross_tab) >= 5) {
      chi_test <- chisq.test(cross_tab)
      cat("Chi-square test p-value:", round(chi_test$p.value, 4), "\n")
    } else {
      # Fisher's exact test for small samples
      fisher_test <- fisher.test(cross_tab, simulate.p.value = TRUE)
      cat("Fisher's exact test p-value:", round(fisher_test$p.value, 4), "\n")
    }
    
    # Effect size (Cliff's delta for ordinal data) - for mHSPC vs mCRPC
    if(require(effsize, quietly = TRUE)) {
      cliff_delta <- cliff.delta(mhspc_scores, mcrpc_scores)
      cat("Cliff's delta (mHSPC vs mCRPC effect size):", round(cliff_delta$estimate, 3), "\n")
      cat("Effect size interpretation:", cliff_delta$magnitude, "\n")
    } else {
      # Alternative: Cohen's d (though less appropriate for ordinal data)
      pooled_sd <- sqrt(((length(mhspc_scores)-1)*var(mhspc_scores) + (length(mcrpc_scores)-1)*var(mcrpc_scores)) /
                       (length(mhspc_scores) + length(mcrpc_scores) - 2))
      cohens_d <- (mean(mcrpc_scores) - mean(mhspc_scores)) / pooled_sd
      cat("Cohen's d (mHSPC vs mCRPC effect size):", round(cohens_d, 3), "\n")
      cat("Effect size interpretation:",
          ifelse(abs(cohens_d) < 0.2, "negligible",
                ifelse(abs(cohens_d) < 0.5, "small",
                      ifelse(abs(cohens_d) < 0.8, "medium", "large"))), "\n")
    }
  }

  # Also calculate effect size for Local vs mCRPC if both exist
  if(length(local_scores) > 0 & length(mcrpc_scores) > 0) {
    if(require(effsize, quietly = TRUE)) {
      cliff_delta_local <- cliff.delta(local_scores, mcrpc_scores)
      cat("Cliff's delta (Local vs mCRPC effect size):", round(cliff_delta_local$estimate, 3), "\n")
      cat("Effect size interpretation:", cliff_delta_local$magnitude, "\n")
    } else {
      # Alternative: Cohen's d
      pooled_sd_local <- sqrt(((length(local_scores)-1)*var(local_scores) + (length(mcrpc_scores)-1)*var(mcrpc_scores)) /
                       (length(local_scores) + length(mcrpc_scores) - 2))
      cohens_d_local <- (mean(mcrpc_scores) - mean(local_scores)) / pooled_sd_local
      cat("Cohen's d (Local vs mCRPC effect size):", round(cohens_d_local, 3), "\n")
      cat("Effect size interpretation:",
          ifelse(abs(cohens_d_local) < 0.2, "negligible",
                ifelse(abs(cohens_d_local) < 0.5, "small",
                      ifelse(abs(cohens_d_local) < 0.8, "medium", "large"))), "\n")
    }
  }
  
  return(summary_stats)
}

# Analyze each marker
markers <- c("CD138", "CD276", "GDF15", "TROP2")
results_list <- list()

for(marker in markers) {
  results_list[[marker]] <- compare_markers(df_analysis, marker)
}

```

## Visualization

Create plots to visualize the differences between mHSPC and mCRPC for each marker.

```{r}
library(ggplot2)
library(gridExtra)

# Function to create comparison plots with significance testing
create_comparison_plot <- function(data, marker_name) {
  
  # Filter valid data
  plot_data <- data %>%
    filter(get(marker_name) >= 0, !is.na(get(marker_name)), !is.na(disease_stage))
  
  if(nrow(plot_data) == 0) return(NULL)
  
  # Check if we have both groups for significance testing
  groups_present <- unique(plot_data$disease_stage)
  perform_test <- length(groups_present) == 2
  
  # Calculate sample sizes for annotation
  sample_sizes <- plot_data %>%
    group_by(disease_stage) %>%
    summarise(n = n(), .groups = "drop")
  
  # Box plot with significance annotation
  p1 <- ggplot(plot_data, aes(x = disease_stage, y = get(marker_name), fill = disease_stage)) +
    geom_boxplot(alpha = 0.7, outlier.shape = NA) +  # Remove outlier points to avoid duplication
    geom_jitter(width = 0.2, height = 0, alpha = 0.6, size = 1.5) +  # Only horizontal jitter
    # Add sample size annotations above each boxplot
    geom_text(data = sample_sizes, aes(x = disease_stage, y = 3.3, label = paste0("n=", n)), 
              inherit.aes = FALSE, size = 3.5, fontface = "bold") +
    scale_y_continuous(breaks = 0:3, limits = c(-0.2, 3.8)) +  # Extra space for sample sizes and significance
    labs(title = paste(marker_name, "Expression by Disease Stage"),
         x = "Disease Stage", 
         y = paste(marker_name, "Score (0-3)"),
         fill = "Disease Stage") +
    theme_minimal() +
    theme(legend.position = "none") +  # Remove legend since x-axis is clear
    scale_fill_manual(values = c("Local" = "#2ECC71", "mHSPC" = "#3498DB", "mCRPC" = "#E74C3C"))
  
  # Add significance annotation if both groups present
  if(perform_test && require(ggsignif, quietly = TRUE)) {
    # Check which comparisons to make based on available data
    available_stages <- unique(plot_data$disease_stage)
    comparisons <- list()

    if("Local" %in% available_stages && "mCRPC" %in% available_stages) {
      comparisons <- append(comparisons, list(c("Local", "mCRPC")))
    }
    if("mHSPC" %in% available_stages && "mCRPC" %in% available_stages) {
      comparisons <- append(comparisons, list(c("mHSPC", "mCRPC")))
    }

    if(length(comparisons) > 0) {
      p1 <- p1 +
        geom_signif(
          comparisons = comparisons,
          test = "wilcox.test",
          map_signif_level = FALSE,
          textsize = 4,
          step_increase = 0.1,
          y_position = 3.6  # Position significance above sample sizes
        )
    }
  }
  
  # Stacked bar plot showing score distribution
  p2 <- plot_data %>%
    count(disease_stage, score = get(marker_name)) %>%
    group_by(disease_stage) %>%
    mutate(prop = n / sum(n) * 100) %>%
    ggplot(aes(x = disease_stage, y = prop, fill = factor(score))) +
    geom_col(position = "stack", alpha = 0.8) +
    geom_text(aes(label = ifelse(prop > 8, paste0(round(prop, 1), "%"), "")), 
              position = position_stack(vjust = 0.5), size = 3, color = "white", fontface = "bold") +
    labs(title = paste(marker_name, "Score Distribution"),
         x = "Disease Stage",
         y = "Percentage (%)",
         fill = "TMA Score") +
    theme_minimal() +
    scale_fill_viridis_d(option = "plasma", name = "Score") +
    theme(legend.position = "right")
  
  # Alternative: Side-by-side bar plot for clearer comparison
  plot_data_summary <- plot_data %>%
    count(disease_stage, score = get(marker_name)) %>%
    group_by(disease_stage) %>%
    mutate(prop = n / sum(n) * 100)
  
  max_prop <- max(plot_data_summary$prop, na.rm = TRUE)
  
  p3 <- plot_data_summary %>%
    ggplot(aes(x = factor(score), y = prop, fill = disease_stage)) +
    geom_col(position = "dodge", alpha = 0.8) +
    geom_text(aes(label = paste0(n, "\n(", round(prop, 1), "%)")), 
              position = position_dodge(width = 0.9), vjust = -0.5, size = 3.5) +
    scale_y_continuous(limits = c(0, max_prop + 5)) +
    theme_custom +
    scale_fill_manual(values = c("Local" = "#AED6F1", "mHSPC" = "#FFBB78", "mCRPC" = "#98DF8A")) +
    theme(legend.position = "top")
  
  # Add statistical test result as subtitle for distribution plots
  if(perform_test) {
    # Create contingency table for chi-square/Fisher's test
    cont_table <- table(plot_data$disease_stage, plot_data[[marker_name]])
    
    # Cochran-Armitage trend test (most appropriate for ordinal TMA data)
    if(require(DescTools, quietly = TRUE) && nrow(cont_table) >= 2 && ncol(cont_table) >= 2) {
      # Check if we have both disease stages and multiple TMA scores
      disease_stages <- unique(plot_data$disease_stage)
      tma_scores <- unique(plot_data[[marker_name]])
      
      if(length(disease_stages) >= 2 && length(tma_scores) >= 2) {
        tryCatch({
          # Create proper matrix format for Cochran-Armitage test
          # Rows: disease stages (mHSPC, mCRPC), Columns: TMA scores (0,1,2,3)
          
          # Ensure we have the correct row order - use available disease stages
          available_stages <- rownames(cont_table)
          stage_order <- intersect(c("Local", "mHSPC", "mCRPC"), available_stages)
          cont_table_ordered <- cont_table[stage_order, , drop = FALSE]
          
          ca_test <- CochranArmitageTest(cont_table_ordered, alternative = "one.sided")
          trend_result <- paste0("Cochran-Armitage trend: p = ", format.pval(ca_test$p.value, digits = 3))
          
          # Choose appropriate test based on sample size for backup
          if(min(cont_table) >= 5) {
            chi_test <- chisq.test(cont_table)
            chi_result <- paste0("χ² test: p = ", format.pval(chi_test$p.value, digits = 3))
          } else {
            fisher_test <- fisher.test(cont_table, simulate.p.value = TRUE)
            chi_result <- paste0("Fisher's test: p = ", format.pval(fisher_test$p.value, digits = 3))
          }
          
          test_result <- paste0(trend_result, " | ", chi_result)
          
        }, error = function(e) {
          # Fallback to chi-square/Fisher's if Cochran-Armitage fails
          cat("Cochran-Armitage test failed for", marker_name, "- using fallback test\n")
          if(min(cont_table) >= 5) {
            chi_test <- chisq.test(cont_table)
            test_result <<- paste0("χ² test: p = ", format.pval(chi_test$p.value, digits = 3))
          } else {
            fisher_test <- fisher.test(cont_table, simulate.p.value = TRUE)
            test_result <<- paste0("Fisher's test: p = ", format.pval(fisher_test$p.value, digits = 3))
          }
        })
      } else {
        # Not suitable for trend test - use contingency table test
        if(min(cont_table) >= 5) {
          chi_test <- chisq.test(cont_table)
          test_result <- paste0("χ² test: p = ", format.pval(chi_test$p.value, digits = 3))
        } else {
          fisher_test <- fisher.test(cont_table, simulate.p.value = TRUE)
          test_result <- paste0("Fisher's test: p = ", format.pval(fisher_test$p.value, digits = 3))
        }
      }
      
    } else {
      # Fallback to chi-square/Fisher's if DescTools not available
      if(min(cont_table) >= 5) {
        chi_test <- chisq.test(cont_table)
        test_result <- paste0("χ² test: p = ", format.pval(chi_test$p.value, digits = 3))
      } else {
        fisher_test <- fisher.test(cont_table, simulate.p.value = TRUE)
        test_result <- paste0("Fisher's test: p = ", format.pval(fisher_test$p.value, digits = 3))
      }
    }
    
    # Add test result to title
    p3 <- p3 + labs(
      title = paste(marker_name, "Score Distribution by Group"),
      subtitle = test_result,
      x = paste(marker_name, "Score"),
      y = "Percentage (%)",
      fill = "Disease Stage"
    )
  } else {
    p3 <- p3 + labs(
      title = paste(marker_name, "Score Distribution by Group"),
      x = paste(marker_name, "Score"),
      y = "Percentage (%)",
      fill = "Disease Stage"
    )
  }
  
  return(list(boxplot = p1, barplot = p2, dodged_bar = p3, plot_data = plot_data, test_result = test_result))
}

# Create plots for each marker
plot_list <- list()
for(marker in markers) {
  plot_list[[marker]] <- create_comparison_plot(df_analysis, marker)
}

# Display plot data for manual inspection
cat("\n=== NON-BINARY PLOT DATA FOR MANUAL INSPECTION ===\n")
for(marker in markers) {
  if(!is.null(plot_list[[marker]]) && !is.null(plot_list[[marker]]$plot_data)) {
    cat("\n--- Plot Data for", marker, "---\n")
    print(plot_list[[marker]]$plot_data)
    cat("\nSample sizes by group:\n")
    print(table(plot_list[[marker]]$plot_data$disease_stage))
    
    # Calculate and display sample sizes like in the plot
    sample_sizes <- plot_list[[marker]]$plot_data %>%
      group_by(disease_stage) %>%
      summarise(n = n(), .groups = "drop")
    cat("\nSample sizes for plot annotation:\n")
    print(sample_sizes)
    
    # Display test results
    if(!is.null(plot_list[[marker]]$test_result)) {
      cat("\nStatistical test result:\n")
      cat(plot_list[[marker]]$test_result, "\n")
    }
  }
}

# Extract and summarize all test results
cat("\n=== SUMMARY OF ALL STATISTICAL TEST RESULTS ===\n")
test_results_summary <- data.frame(
  Marker = character(),
  Test_Result = character(),
  stringsAsFactors = FALSE
)

for(marker in markers) {
  if(!is.null(plot_list[[marker]]) && !is.null(plot_list[[marker]]$test_result)) {
    test_results_summary <- rbind(test_results_summary, data.frame(
      Marker = marker,
      Test_Result = plot_list[[marker]]$test_result
    ))
  }
}

print(test_results_summary)

# Save test results
write.csv(test_results_summary, 
          file.path(wd$outCurr, "TMA_statistical_test_results.csv"), 
          row.names = FALSE)

cat("Statistical test results saved:", file.path(wd$outCurr, "TMA_statistical_test_results.csv"), "\n\n")

# Also create combined summary including binary results
cat("=== COMBINED TEST RESULTS SUMMARY (Non-Binary + Binary) ===\n")
combined_test_results <- data.frame(
  Marker = character(),
  Non_Binary_Test = character(),
  Binary_Test = character(),
  stringsAsFactors = FALSE
)

binary_plot_list <- list()
for(marker in markers) {
  non_binary_result <- if(!is.null(plot_list[[marker]]$test_result)) plot_list[[marker]]$test_result else "No data"
  binary_result <- if(!is.null(binary_plot_list[[marker]]$test_result)) binary_plot_list[[marker]]$test_result else "No data"
  
  combined_test_results <- rbind(combined_test_results, data.frame(
    Marker = marker,
    Non_Binary_Test = non_binary_result,
    Binary_Test = binary_result
  ))
}

print(combined_test_results)

# Save combined results
write.csv(combined_test_results, 
          file.path(wd$outCurr, "TMA_combined_statistical_results.csv"), 
          row.names = FALSE)

cat("Combined test results saved:", file.path(wd$outCurr, "TMA_combined_statistical_results.csv"), "\n\n")

# Save individual plots
for(marker in markers) {
  if(!is.null(plot_list[[marker]])) {
    
    # Save box plot with significance
    ggsave(file.path(wd$outCurr, paste0(marker, "_boxplot_with_significance.pdf")),
           plot_list[[marker]]$boxplot, width = 6, height = 5)
    
    # Save stacked distribution plot  
    ggsave(file.path(wd$outCurr, paste0(marker, "_stacked_distribution.pdf")),
           plot_list[[marker]]$barplot, width = 7, height = 5)
    
    # Save side-by-side distribution plot
    ggsave(file.path(wd$outCurr, paste0(marker, "_dodged_distribution.pdf")),
           plot_list[[marker]]$dodged_bar, width = 7, height = 5)
  }
}

# Create combined plots
valid_plots <- plot_list[!sapply(plot_list, is.null)]
if(length(valid_plots) > 0) {
  
  # Combined boxplots
  pdf(file.path(wd$outCurr, "All_markers_boxplot_comparison.pdf"), width = 12, height = 8)
  grid.arrange(grobs = lapply(valid_plots, function(x) x$boxplot), ncol = 2)
  dev.off()
  
  # Combined dodged distribution plots - one page each
  pdf(file.path(wd$outCurr, "All_markers_dodged_distributions.pdf"), width = 8, height = 6)
  for(marker in names(valid_plots)) {
    grid.arrange(valid_plots[[marker]]$dodged_bar)
  }
  dev.off()
}

cat("Comparison plots saved to:", wd$outCurr, "\n")
```

## Binary Analysis (Low vs High Expression)

Create binary categories (0+1 = Low, 2+3 = High) for cleaner statistical analysis.

```{r}
# Function to create binary comparison plots (Low vs High expression)
create_binary_comparison <- function(data, marker_name) {
  
  # Filter valid data and create binary categories
  plot_data <- data %>%
    filter(get(marker_name) >= 0, !is.na(get(marker_name)), !is.na(disease_stage)) %>%
    mutate(
      expression_level = ifelse(get(marker_name) <= 2, "Low (0-2)", "High (3)"),
      expression_level = factor(expression_level, levels = c("Low (0-2)", "High (3)"))
    )
  
  if(nrow(plot_data) == 0) return(NULL)
  
  # Check if we have both groups for significance testing
  groups_present <- unique(plot_data$disease_stage)
  perform_test <- length(groups_present) == 2
  
  # Create contingency table
  cont_table <- table(plot_data$disease_stage, plot_data$expression_level)
  
  # Statistical test
  test_result <- ""
  if(perform_test && min(cont_table) > 0) {
    if(min(cont_table) >= 5) {
      chi_test <- chisq.test(cont_table)
      test_result <- paste0("χ² test: p = ", format.pval(chi_test$p.value, digits = 3))
    } else {
      fisher_test <- fisher.test(cont_table, alternative="greater")
      test_result <- paste0("Fisher's test: p = ", format.pval(fisher_test$p.value, digits = 3))
    }
  }
  
  # 1. Stacked bar plot
  p1 <- plot_data %>%
    count(disease_stage, expression_level) %>%
    group_by(disease_stage) %>%
    mutate(
      prop = n / sum(n) * 100,
      total_n = sum(n)
    ) %>%
    ggplot(aes(x = disease_stage, y = prop, fill = expression_level)) +
    geom_col(position = "stack", alpha = 0.8) +
    geom_text(aes(label = paste0(n, "\n(", round(prop, 1), "%)")), 
              position = position_stack(vjust = 0.5), size = 3.5, fontface = "bold") +
    geom_text(aes(x = disease_stage, y = 102, label = paste0("n=", total_n)), 
              size = 3, color = "black", inherit.aes = FALSE) +
    labs(title = paste(marker_name, "Expression Categories"),
         subtitle = test_result,
         x = "Disease Stage", 
         y = "Percentage (%)",
         fill = "Expression Level") +
    theme_custom +
    scale_fill_manual(values = c("Low (0-2)" = "#FF7F7F", "High (3)" = "#7F7FFF")) +
    scale_y_continuous(limits = c(0, 110), breaks = seq(0, 100, 25)) +
    theme(legend.position = "top")
  
  # 2. Side-by-side bar plot
  p2 <- plot_data %>%
    count(disease_stage, expression_level) %>%
    group_by(disease_stage) %>%
    mutate(prop = n / sum(n) * 100) %>%
    ggplot(aes(x = expression_level, y = prop, fill = disease_stage)) +
    geom_col(position = "dodge", alpha = 0.8) +
    geom_text(aes(label = paste0(n, "\n(", round(prop, 1), "%)")), 
              position = position_dodge(width = 0.9), vjust = -0.5, size = 3.5) +
    labs(title = paste(marker_name, "Distribution by Expression Level"),
         subtitle = test_result,
         x = "Expression Level", 
         y = "Percentage (%)",
         fill = "Disease Stage") +
    theme_custom +
    scale_fill_manual(values = c("Local" = "#AED6F1", "mHSPC" = "#FFBB78", "mCRPC" = "#98DF8A")) +
    scale_y_continuous(limits = c(0, 110), breaks = seq(0, 100, 25)) +
    # scale_y_continuous(limits = c(0, max(plot_data %>% count(disease_stage, expression_level) %>% 
    #                                     group_by(expression_level) %>% 
    #                                     mutate(prop = n/sum(n)*100) %>% pull(prop)) * 1.2)) +
    theme(legend.position = "top")
  
  return(list(stacked = p1, dodged = p2, contingency_table = cont_table, test_result = test_result, plot_data = plot_data))
}

# Create binary plots for each marker
binary_stats <- data.frame(
  Marker = character(),
  mHSPC_Low = numeric(),
  mHSPC_High = numeric(),
  mCRPC_Low = numeric(),
  mCRPC_High = numeric(),
  Test_Result = character(),
  stringsAsFactors = FALSE
)

for(marker in markers) {
  binary_plot_list[[marker]] <- create_binary_comparison(df_analysis, marker)
  
  if(!is.null(binary_plot_list[[marker]])) {
    # Extract contingency table data
    cont_table <- binary_plot_list[[marker]]$contingency_table
    test_result <- binary_plot_list[[marker]]$test_result
    
    # Add to summary table
    binary_stats <- rbind(binary_stats, data.frame(
      Marker = marker,
      Local_Low = ifelse("Local" %in% rownames(cont_table) && "Low (0-2)" %in% colnames(cont_table),
                        cont_table["Local", "Low (0-2)"], 0),
      Local_High = ifelse("Local" %in% rownames(cont_table) && "High (3)" %in% colnames(cont_table),
                         cont_table["Local", "High (3)"], 0),
      mHSPC_Low = ifelse("mHSPC" %in% rownames(cont_table) && "Low (0-2)" %in% colnames(cont_table),
                        cont_table["mHSPC", "Low (0-2)"], 0),
      mHSPC_High = ifelse("mHSPC" %in% rownames(cont_table) && "High (3)" %in% colnames(cont_table),
                         cont_table["mHSPC", "High (3)"], 0),
      mCRPC_Low = ifelse("mCRPC" %in% rownames(cont_table) && "Low (0-2)" %in% colnames(cont_table),
                        cont_table["mCRPC", "Low (0-2)"], 0),
      mCRPC_High = ifelse("mCRPC" %in% rownames(cont_table) && "High (3)" %in% colnames(cont_table),
                         cont_table["mCRPC", "High (3)"], 0),
      Test_Result = test_result
    ))
  }
}

# Display binary analysis results
cat("=== Binary Expression Analysis (Low 0-2 vs High 3) ===\n")
print(binary_stats)

# Display binary plot data for manual inspection
cat("\n=== BINARY PLOT DATA FOR MANUAL INSPECTION ===\n")
for(marker in markers) {
  if(!is.null(binary_plot_list[[marker]]) && !is.null(binary_plot_list[[marker]]$plot_data)) {
    cat("\n--- Binary Plot Data for", marker, "---\n")
    print(binary_plot_list[[marker]]$plot_data)
    cat("\nCross-tabulation (Disease Stage vs Expression Level):\n")
    print(binary_plot_list[[marker]]$contingency_table)
    cat("\nTest result:", binary_plot_list[[marker]]$test_result, "\n")
  }
}

# Save binary plots
for(marker in markers) {
  if(!is.null(binary_plot_list[[marker]])) {
    # Save stacked plot
    ggsave(file.path(wd$outCurr, paste0(marker, "_binary_stacked.pdf")),
           binary_plot_list[[marker]]$stacked, width = 7, height = 6)
    
    # Save dodged plot
    ggsave(file.path(wd$outCurr, paste0(marker, "_binary_dodged.pdf")),
           binary_plot_list[[marker]]$dodged, width = 7, height = 6)
  }
}

# Create combined binary analysis PDF - one page each
valid_binary_plots <- binary_plot_list[!sapply(binary_plot_list, is.null)]
if(length(valid_binary_plots) > 0) {
  
  # Combined stacked binary plots
  pdf(file.path(wd$outCurr, "All_markers_binary_stacked.pdf"), width = 8, height = 6)
  for(marker in names(valid_binary_plots)) {
    grid.arrange(valid_binary_plots[[marker]]$stacked)
  }
  dev.off()
  
  # Combined dodged binary plots  
  pdf(file.path(wd$outCurr, "All_markers_binary_dodged.pdf"), width = 8, height = 6)
  for(marker in names(valid_binary_plots)) {
    grid.arrange(valid_binary_plots[[marker]]$dodged)
  }
  dev.off()
}

# Save binary statistics
write.csv(binary_stats, 
          file.path(wd$outCurr, "TMA_binary_analysis_statistics.csv"), 
          row.names = FALSE)

cat("Binary analysis plots saved to:", wd$outCurr, "\n")
cat("Binary statistics saved:", file.path(wd$outCurr, "TMA_binary_analysis_statistics.csv"), "\n")
```

## Summary of Statistical Results

```{r}
# Create summary table of all statistical results
if(require(broom)) {
  
  statistical_summary <- data.frame(
    Marker = character(),
    mHSPC_n = numeric(),
    mHSPC_mean = numeric(),
    mCRPC_n = numeric(), 
    mCRPC_mean = numeric(),
    Mann_Whitney_p = numeric(),
    Effect_size = character(),
    stringsAsFactors = FALSE
  )
  
  for(marker in markers) {
    
    # Get valid data
    valid_data <- df_analysis %>%
      filter(get(marker) >= 0, !is.na(get(marker)), !is.na(disease_stage))
    
    if(nrow(valid_data) == 0) next
    
    # Group statistics
    group_stats <- valid_data %>%
      group_by(disease_stage) %>%
      summarise(n = n(), mean = mean(get(marker)), .groups = "drop")
    
    # Statistical test
    mhspc_scores <- valid_data[[marker]][valid_data$disease_stage == "mHSPC"]
    mcrpc_scores <- valid_data[[marker]][valid_data$disease_stage == "mCRPC"]
    
    if(length(mhspc_scores) > 0 & length(mcrpc_scores) > 0) {
      wilcox_p <- wilcox.test(mhspc_scores, mcrpc_scores)$p.value
      
      # Calculate effect size
      if(require(effsize, quietly = TRUE)) {
        cliff_delta <- cliff.delta(mhspc_scores, mcrpc_scores)
        effect_size_text <- paste0(round(cliff_delta$estimate, 3), " (", cliff_delta$magnitude, ")")
      } else {
        # Alternative: Cohen's d
        pooled_sd <- sqrt(((length(mhspc_scores)-1)*var(mhspc_scores) + (length(mcrpc_scores)-1)*var(mcrpc_scores)) / 
                         (length(mhspc_scores) + length(mcrpc_scores) - 2))
        cohens_d <- (mean(mcrpc_scores) - mean(mhspc_scores)) / pooled_sd
        magnitude <- ifelse(abs(cohens_d) < 0.2, "negligible", 
                           ifelse(abs(cohens_d) < 0.5, "small",
                                 ifelse(abs(cohens_d) < 0.8, "medium", "large")))
        effect_size_text <- paste0(round(cohens_d, 3), " (", magnitude, ")")
      }
      
      # Add to summary
      statistical_summary <- rbind(statistical_summary, data.frame(
        Marker = marker,
        Local_n = ifelse("Local" %in% group_stats$disease_stage, group_stats$n[group_stats$disease_stage == "Local"], 0),
        Local_mean = ifelse("Local" %in% group_stats$disease_stage, round(group_stats$mean[group_stats$disease_stage == "Local"], 2), NA),
        mHSPC_n = ifelse("mHSPC" %in% group_stats$disease_stage, group_stats$n[group_stats$disease_stage == "mHSPC"], 0),
        mHSPC_mean = ifelse("mHSPC" %in% group_stats$disease_stage, round(group_stats$mean[group_stats$disease_stage == "mHSPC"], 2), NA),
        mCRPC_n = ifelse("mCRPC" %in% group_stats$disease_stage, group_stats$n[group_stats$disease_stage == "mCRPC"], 0),
        mCRPC_mean = ifelse("mCRPC" %in% group_stats$disease_stage, round(group_stats$mean[group_stats$disease_stage == "mCRPC"], 2), NA),
        Mann_Whitney_p = round(wilcox_p, 4),
        Effect_size = effect_size_text
      ))
    }
  }
  
  cat("=== Statistical Summary ===\n")
  print(statistical_summary)
  
  # Save results
  write.csv(statistical_summary,
            file.path(wd$outCurr, "TMA_markers_Local_mHSPC_mCRPC_statistics.csv"),
            row.names = FALSE)

  cat("Statistical summary saved:", file.path(wd$outCurr, "TMA_markers_Local_mHSPC_mCRPC_statistics.csv"), "\n")
}
```


# Obj 4: mCRPC GDF 15 bone mets

GDF15 appears to promote bone mets (https://pmc.ncbi.nlm.nih.gov/articles/PMC8776828/). 

Lets try to compare mHSCP bone vs non-bone, and mCRPC bone vs non-bone

```{r}
# GDF15 Analysis: mHSPC vs mCRPC stratified by bone vs non-bone sites
# Load required libraries
library(dplyr)
library(ggplot2)
library(tidyr)
library(broom)

# Data preprocessing
df_analysis <- df_tma_combined %>%
  # Remove rows with missing disease_stage or GDF15 = -1
  filter(!is.na(disease_stage),
         disease_stage %in% c("Local", "mHSPC", "mCRPC")) %>%
  # Create bone vs non-bone grouping
  mutate(
    organ_group = case_when(
      tolower(organ) == "bone" ~ "Bone",
      TRUE ~ "Non-bone"
    ),
    # Create categorical GDF15 variable
    GDF15_cat = case_when(
      GDF15 %in% c(0, 1) ~ "Low (0-2)",
      GDF15 %in% c(2,3) ~ "High (3)",
      TRUE ~ NA_character_
    ),
    CD138_cat = case_when(
      CD138 %in% c(0, 1) ~ "Low (0-2)",
      CD138 %in% c(2,3) ~ "High (3)",
      TRUE ~ NA_character_
      ),
    # Ensure proper factor levels
    disease_stage = factor(disease_stage, levels = c("Local", "mHSPC", "mCRPC")),
    organ_group = factor(organ_group, levels = c("Bone", "Non-bone")),
    GDF15_cat = factor(GDF15_cat, levels = (c("Low (0-2)", "High (3)"))),
    CD138_cat = factor(CD138_cat, levels = (c("Low (0-2)", "High (3)")))
  )

# Summary statistics
print("=== DATASET SUMMARY ===")
print(paste("Total samples after filtering:", nrow(df_analysis)))
print(table(df_analysis$disease_stage, df_analysis$organ_group))

print("\n=== GDF15 DISTRIBUTION BY GROUP ===")
summary_stats <- df_analysis %>%
  group_by(disease_stage, organ_group) %>%
  summarise(
    n = n(),
    mean_GDF15 = mean(GDF15, na.rm = TRUE),
    median_GDF15 = median(GDF15, na.rm = TRUE),
    sd_GDF15 = sd(GDF15, na.rm = TRUE),
    min_GDF15 = min(GDF15, na.rm = TRUE),
    max_GDF15 = max(GDF15, na.rm = TRUE),
    .groups = 'drop'
  )
print(summary_stats)

# 1) CONTINUOUS ANALYSIS
# print("\n=== 1) CONTINUOUS ANALYSIS (GDF15 as 0,1,2,3) ===")
# 
# # Wilcoxon rank-sum tests for each organ group
# print("\nWilcoxon Rank-Sum Tests:")
# 
# # Bone metastases
# bone_data <- df_analysis %>% filter(organ_group == "Bone")
# if(nrow(bone_data) > 0) {
#   bone_test <- wilcox.test(GDF15 ~ disease_stage, data = bone_data)
#   print(paste("Bone metastases - mHSPC vs mCRPC:"))
#   print(paste("  W =", bone_test$statistic, ", p-value =", format.pval(bone_test$p.value)))
# }
# 
# # Non-bone metastases
# nonbone_data <- df_analysis %>% filter(organ_group == "Non-bone")
# if(nrow(nonbone_data) > 0) {
#   nonbone_test <- wilcox.test(GDF15 ~ disease_stage, data = nonbone_data)
#   print(paste("Non-bone metastases - mHSPC vs mCRPC:"))
#   print(paste("  W =", nonbone_test$statistic, ", p-value =", format.pval(nonbone_test$p.value)))
# }

# 2) CATEGORICAL ANALYSIS
print("\n=== 2) CATEGORICAL ANALYSIS (Low 0-2 vs High 3) ===")

# Contingency tables and Fisher's exact tests
print("\nContingency Tables and Fisher's Exact Tests:")

# # Bone metastases
# if(nrow(bone_data) > 0) {
#   bone_table <- table(bone_data$disease_stage, bone_data$GDF15_cat)
#   print("Bone metastases:")
#   print(bone_table)
#   if(all(bone_table > 0)) {
#     bone_fisher <- fisher.test(bone_table)
#     print(paste("  Fisher's exact test p-value =", format.pval(bone_fisher$p.value)))
#     print(paste("  Odds ratio =", round(bone_fisher$estimate, 2)))
#   } else {
#     print("  Cannot perform Fisher's test - zero cells present")
#   }
# }
# 
# # Non-bone metastases
# if(nrow(nonbone_data) > 0) {
#   nonbone_table <- table(nonbone_data$disease_stage, nonbone_data$GDF15_cat)
#   print("\nNon-bone metastases:")
#   print(nonbone_table)
#   if(all(nonbone_table > 0)) {
#     nonbone_fisher <- fisher.test(nonbone_table)
#     print(paste("  Fisher's exact test p-value =", format.pval(nonbone_fisher$p.value)))
#     print(paste("  Odds ratio =", round(nonbone_fisher$estimate, 2)))
#   } else {
#     print("  Cannot perform Fisher's test - zero cells present")
#   }
# }

# VISUALIZATION
print("\n=== CREATING VISUALIZATIONS ===")

# Plot 1: Continuous GDF15 distribution
p1 <- ggplot(df_analysis, aes(x = disease_stage, y = GDF15, fill = disease_stage)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.6, size = 2) +
  facet_wrap(~organ_group) +
  scale_fill_manual(values = c("Local" = "#2ECC71", "mHSPC" = "#3498db", "mCRPC" = "#e74c3c")) +
  labs(
    title = "GDF15 Expression: Local vs mHSPC vs mCRPC by Organ Site",
    subtitle = "Continuous analysis (0-3 scale)",
    x = "Disease Stage",
    y = "GDF15 Expression Level",
    fill = "Disease Stage"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    strip.text = element_text(size = 12, face = "bold"),
    legend.position = "bottom"
  )

print(p1)

# Plot 2: Categorical GDF15 proportions
prop_data <- df_analysis %>%
  filter(GDF15 != -1) %>% 
  group_by(disease_stage, organ_group, GDF15_cat) %>%
  summarise(n = n(), .groups = 'drop') %>%
  group_by(disease_stage, organ_group) %>%
  mutate(
    total = sum(n),
    proportion = n / total * 100
  ) %>%
  ungroup()

# Create sample size labels for top of bars
sample_size_data <- prop_data %>%
  group_by(disease_stage, organ_group) %>%
  summarise(total = first(total), .groups = 'drop') %>%
  mutate(label = paste0("n=", total))

p2 <- ggplot(prop_data, aes(x = disease_stage, y = proportion, fill = GDF15_cat)) +
  geom_col(position = "stack", alpha = 0.8) +
  facet_wrap(~disease_stage) +
  scale_fill_manual(
    values = c("Low (0-2)" = "#95a5a6", "High (3)" = "#f39c12"),
    name = "GDF15 Level"
  ) +
  labs(
    title = "GDF15 Expression Categories: Local vs mHSPC vs mCRPC by Organ Site",
    subtitle = "Categorical analysis (Low: 0-2, High: 3)",
    x = "Disease Stage",
    y = "Percentage (%)",
    fill = "GDF15 Category"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    strip.text = element_text(size = 12, face = "bold"),
    legend.position = "bottom"
  ) +
  geom_text(aes(label = paste0(round(proportion, 1), "%")), 
            position = position_stack(vjust = 0.5), 
            color = "white", fontweight = "bold", size = 3) +
  geom_text(data = sample_size_data, 
            aes(x = disease_stage, y = 105, label = label), 
            inherit.aes = FALSE, 
            size = 3.5, fontface = "bold", color = "black")

print(p2)

# Additional summary table for categorical analysis
print("\n=== CATEGORICAL SUMMARY TABLE ===")
cat_summary <- df_analysis %>%
  group_by(disease_stage, organ_group, GDF15_cat) %>%
  summarise(count = n(), .groups = 'drop') %>%
  group_by(disease_stage, organ_group) %>%
  mutate(
    total = sum(count),
    percentage = round(count / total * 100, 1)
  ) %>%
  ungroup() %>%
  select(disease_stage, organ_group, GDF15_cat, count, percentage) %>%
  arrange(organ_group, disease_stage, GDF15_cat)

print(cat_summary)
```

## GDF15

GDF15 Analysis with Statistical Testing - Test if mCRPC has higher expression (2-3) compared to other groups

```{r}
# GDF15 Analysis with Statistical Testing
# Test if mCRPC has higher expression (2-3) compared to other groups

# Filter valid GDF15 data
gdf15_data <- df_analysis %>%
  filter(GDF15 != -1, !is.na(GDF15)) %>%
  mutate(
    GDF15_high = ifelse(GDF15 %in% c(3), 1, 0),  # Binary: 1 = high (3), 0 = low (0-2)
    GDF15_cat = case_when(
      GDF15 %in% c(0, 1, 2) ~ "Low (0-2)",
      GDF15 %in% c(3) ~ "High (3)",
      TRUE ~ NA_character_
    ),
    GDF15_cat = factor(GDF15_cat, levels = c("Low (0-2)", "High (3)"))
  )

# Print sample sizes
cat("=== GDF15 Sample Sizes ===\n")
print(table(gdf15_data$disease_stage))

# Statistical tests comparing mCRPC vs other groups for high expression
cat("\n=== GDF15 Statistical Tests: mCRPC vs Others for High Expression (3) ===\n")

# Create contingency table for binary analysis
cont_table_gdf15 <- table(gdf15_data$disease_stage, gdf15_data$GDF15_cat)
print("Contingency Table (Binary):")
print(cont_table_gdf15)

# Create contingency table for trend test using original values (0,1,2,3)
cont_table_gdf15_trend <- table(gdf15_data$disease_stage, gdf15_data$GDF15)
print("Contingency Table (Original Values 0-3):")
print(cont_table_gdf15_trend)

# Cochran-Armitage Trend Test (requires exactly 2 groups)
if(require(DescTools, quietly = TRUE) && nrow(cont_table_gdf15_trend) >= 2 && ncol(cont_table_gdf15_trend) >= 2) {
  available_stages <- rownames(cont_table_gdf15_trend)

  # Test 1: Local vs mCRPC
  if("Local" %in% available_stages && "mCRPC" %in% available_stages) {
    cont_table_local_mcrpc_gdf15 <- cont_table_gdf15_trend[c("Local", "mCRPC"), , drop = FALSE]
    tryCatch({
      ca_test_local_mcrpc_gdf15 <- CochranArmitageTest(cont_table_local_mcrpc_gdf15, alternative = "one.sided")
      cat("\nCochran-Armitage Trend Test - Local vs mCRPC (GDF15):\n")
      cat("p-value:", format.pval(ca_test_local_mcrpc_gdf15$p.value, digits = 3), "\n")
      cat("Test statistic:", round(ca_test_local_mcrpc_gdf15$statistic, 3), "\n")
    }, error = function(e) {
      cat("\nCochran-Armitage test (Local vs mCRPC) failed for GDF15:", e$message, "\n")
    })
  }

  # Test 2: mHSPC vs mCRPC (if mHSPC exists)
  if("mHSPC" %in% available_stages && "mCRPC" %in% available_stages) {
    cont_table_mhspc_mcrpc_gdf15 <- cont_table_gdf15_trend[c("mHSPC", "mCRPC"), , drop = FALSE]
    tryCatch({
      ca_test_mhspc_mcrpc_gdf15 <- CochranArmitageTest(cont_table_mhspc_mcrpc_gdf15, alternative = "one.sided")
      cat("\nCochran-Armitage Trend Test - mHSPC vs mCRPC (GDF15):\n")
      cat("p-value:", format.pval(ca_test_mhspc_mcrpc_gdf15$p.value, digits = 3), "\n")
      cat("Test statistic:", round(ca_test_mhspc_mcrpc_gdf15$statistic, 3), "\n")
    }, error = function(e) {
      cat("\nCochran-Armitage test (mHSPC vs mCRPC) failed for GDF15:", e$message, "\n")
    })
  }
}

# Test 1: Compare mCRPC vs Local for high expression
if("Local" %in% gdf15_data$disease_stage && "mCRPC" %in% gdf15_data$disease_stage) {
  mcrpc_local_data_gdf15 <- gdf15_data %>% filter(disease_stage %in% c("Local", "mCRPC"))

  # Fisher's exact test
  local_mcrpc_table_gdf15 <- table(mcrpc_local_data_gdf15$disease_stage, mcrpc_local_data_gdf15$GDF15_cat)
  if(all(local_mcrpc_table_gdf15 > 0)) {
    fisher_local_gdf15 <- fisher.test(local_mcrpc_table_gdf15, alternative = "greater")
    cat("\nLocal vs mCRPC - Fisher's exact test:\n")
    cat("p-value:", format.pval(fisher_local_gdf15$p.value, digits = 3), "\n")
    cat("Odds ratio:", round(fisher_local_gdf15$estimate, 2), "\n")
    cat("95% CI:", round(fisher_local_gdf15$conf.int[1], 2), "-", round(fisher_local_gdf15$conf.int[2], 2), "\n")
  }

  # Proportion test for high expression
  local_high_gdf15 <- sum(mcrpc_local_data_gdf15$GDF15_high[mcrpc_local_data_gdf15$disease_stage == "Local"])
  local_total_gdf15 <- sum(mcrpc_local_data_gdf15$disease_stage == "Local")
  mcrpc_high_gdf15 <- sum(mcrpc_local_data_gdf15$GDF15_high[mcrpc_local_data_gdf15$disease_stage == "mCRPC"])
  mcrpc_total_gdf15 <- sum(mcrpc_local_data_gdf15$disease_stage == "mCRPC")

  prop_test_local_gdf15 <- prop.test(c(mcrpc_high_gdf15, local_high_gdf15), c(mcrpc_total_gdf15, local_total_gdf15),
                                    alternative = "greater")
  cat("Proportion test (mCRPC > Local for high expression):\n")
  cat("p-value:", format.pval(prop_test_local_gdf15$p.value, digits = 3), "\n")
  cat("mCRPC high expression: ", mcrpc_high_gdf15, "/", mcrpc_total_gdf15, " (",
      round(mcrpc_high_gdf15/mcrpc_total_gdf15*100, 1), "%)\n")
  cat("Local high expression: ", local_high_gdf15, "/", local_total_gdf15, " (",
      round(local_high_gdf15/local_total_gdf15*100, 1), "%)\n")
}

# Test 2: Compare mCRPC vs mHSPC for high expression (if mHSPC exists)
if("mHSPC" %in% gdf15_data$disease_stage && "mCRPC" %in% gdf15_data$disease_stage) {
  mcrpc_mhspc_data_gdf15 <- gdf15_data %>% filter(disease_stage %in% c("mHSPC", "mCRPC"))

  # Fisher's exact test
  mhspc_mcrpc_table_gdf15 <- table(mcrpc_mhspc_data_gdf15$disease_stage, mcrpc_mhspc_data_gdf15$GDF15_cat)
  if(all(mhspc_mcrpc_table_gdf15 > 0)) {
    fisher_mhspc_gdf15 <- fisher.test(mhspc_mcrpc_table_gdf15, alternative = "greater")
    cat("\nmHSPC vs mCRPC - Fisher's exact test:\n")
    cat("p-value:", format.pval(fisher_mhspc_gdf15$p.value, digits = 3), "\n")
    cat("Odds ratio:", round(fisher_mhspc_gdf15$estimate, 2), "\n")
    cat("95% CI:", round(fisher_mhspc_gdf15$conf.int[1], 2), "-", round(fisher_mhspc_gdf15$conf.int[2], 2), "\n")
  }

  # Proportion test for high expression
  mhspc_high_gdf15 <- sum(mcrpc_mhspc_data_gdf15$GDF15_high[mcrpc_mhspc_data_gdf15$disease_stage == "mHSPC"])
  mhspc_total_gdf15 <- sum(mcrpc_mhspc_data_gdf15$disease_stage == "mHSPC")
  mcrpc_high_2_gdf15 <- sum(mcrpc_mhspc_data_gdf15$GDF15_high[mcrpc_mhspc_data_gdf15$disease_stage == "mCRPC"])
  mcrpc_total_2_gdf15 <- sum(mcrpc_mhspc_data_gdf15$disease_stage == "mCRPC")

  prop_test_mhspc_gdf15 <- prop.test(c(mcrpc_high_2_gdf15, mhspc_high_gdf15), c(mcrpc_total_2_gdf15, mhspc_total_gdf15),
                                    alternative = "greater")
  cat("Proportion test (mCRPC > mHSPC for high expression):\n")
  cat("p-value:", format.pval(prop_test_mhspc_gdf15$p.value, digits = 3), "\n")
  cat("mCRPC high expression: ", mcrpc_high_2_gdf15, "/", mcrpc_total_2_gdf15, " (",
      round(mcrpc_high_2_gdf15/mcrpc_total_2_gdf15*100, 1), "%)\n")
  cat("mHSPC high expression: ", mhspc_high_gdf15, "/", mhspc_total_gdf15, " (",
      round(mhspc_high_gdf15/mhspc_total_gdf15*100, 1), "%)\n")
}

# Create plot with statistical annotations
prop_data <- gdf15_data %>%
  group_by(disease_stage, GDF15_cat) %>%
  summarise(n = n(), .groups = 'drop') %>%
  group_by(disease_stage) %>%
  mutate(
    total = sum(n),
    proportion = n / total * 100
  ) %>%
  ungroup()

# Create sample size labels for top of bars
sample_size_data <- prop_data %>%
  group_by(disease_stage) %>%
  summarise(total = first(total), .groups = 'drop') %>%
  mutate(label = paste0("n=", total))

# Add significance annotations based on tests
significance_text_gdf15 <- ""
if(exists("prop_test_local_gdf15") && exists("prop_test_mhspc_gdf15")) {
  significance_text_gdf15 <- paste0("Local vs mCRPC: p = ", format.pval(prop_test_local_gdf15$p.value, digits = 3),
                                   "; mHSPC vs mCRPC: p = ", format.pval(prop_test_mhspc_gdf15$p.value, digits = 3))
} else if(exists("prop_test_local_gdf15")) {
  significance_text_gdf15 <- paste0("Local vs mCRPC: p = ", format.pval(prop_test_local_gdf15$p.value, digits = 3))
} else if(exists("prop_test_mhspc_gdf15")) {
  significance_text_gdf15 <- paste0("mHSPC vs mCRPC: p = ", format.pval(prop_test_mhspc_gdf15$p.value, digits = 3))
}

p2 <- ggplot(prop_data, aes(x = disease_stage, y = proportion, fill = GDF15_cat)) +
  geom_col(position = "stack", alpha = 0.8) +
  scale_fill_manual(
    values = c("Low (0-2)" = "#95a5a6", "High (3)" = "#f39c12"),
    name = "GDF15 Level"
  ) +
  labs(
    title = "GDF15 Expression Categories",
    subtitle = paste0("Categorical analysis (Low: 0-2, High: 3)\n", significance_text_gdf15),
    x = "Disease Stage",
    y = "Percentage (%)",
    fill = "GDF15 Category"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    strip.text = element_text(size = 12, face = "bold"),
    legend.position = "bottom"
  ) +
  geom_text(aes(label = paste0(round(proportion, 1), "%")),
            position = position_stack(vjust = 0.5),
            color = "white", fontweight = "bold", size = 3) +
  geom_text(data = sample_size_data,
            aes(x = disease_stage, y = 105, label = label),
            inherit.aes = FALSE,
            size = 3.5, fontface = "bold", color = "black")

print(p2)

# Save GDF15 results
gdf15_results <- data.frame(
  Test = character(),
  P_value = numeric(),
  Odds_Ratio = numeric(),
  mCRPC_High_Pct = numeric(),
  Other_High_Pct = numeric(),
  stringsAsFactors = FALSE
)

if(exists("prop_test_local_gdf15")) {
  gdf15_results <- rbind(gdf15_results, data.frame(
    Test = "Local_vs_mCRPC",
    P_value = prop_test_local_gdf15$p.value,
    Odds_Ratio = ifelse(exists("fisher_local_gdf15"), fisher_local_gdf15$estimate, NA),
    mCRPC_High_Pct = mcrpc_high_gdf15/mcrpc_total_gdf15*100,
    Other_High_Pct = local_high_gdf15/local_total_gdf15*100
  ))
}

if(exists("prop_test_mhspc_gdf15")) {
  gdf15_results <- rbind(gdf15_results, data.frame(
    Test = "mHSPC_vs_mCRPC",
    P_value = prop_test_mhspc_gdf15$p.value,
    Odds_Ratio = ifelse(exists("fisher_mhspc_gdf15"), fisher_mhspc_gdf15$estimate, NA),
    mCRPC_High_Pct = mcrpc_high_2_gdf15/mcrpc_total_2_gdf15*100,
    Other_High_Pct = mhspc_high_gdf15/mhspc_total_gdf15*100
  ))
}

print("=== GDF15 Results Summary ===")
print(gdf15_results)
```

## CD138

```{r}
# CD138 Analysis with Statistical Testing
# Test if mCRPC has higher expression (2-3) compared to other groups

# Filter valid CD138 data
cd138_data <- df_analysis %>%
  filter(CD138 != -1, !is.na(CD138)) %>%
  mutate(
    CD138_high = ifelse(CD138 %in% c(3), 1, 0),  # Binary: 1 = high (3), 0 = low (0-2)
    CD138_cat = case_when(
      CD138 %in% c(0, 1, 2) ~ "Low (0-2)",
      CD138 %in% c(3) ~ "High (3)",
      TRUE ~ NA_character_
    ),
    CD138_cat = factor(CD138_cat, levels = c("Low (0-2)", "High (3)"))
  )

# Print sample sizes
cat("=== CD138 Sample Sizes ===\n")
print(table(cd138_data$disease_stage))

# Statistical tests comparing mCRPC vs other groups for high expression
cat("\n=== CD138 Statistical Tests: mCRPC vs Others for High Expression (3) ===\n")

# Create contingency table for binary analysis
cont_table_cd138 <- table(cd138_data$disease_stage, cd138_data$CD138_cat)
print("Contingency Table (Binary):")
print(cont_table_cd138)

# Create contingency table for trend test using original values (0,1,2,3)
cont_table_cd138_trend <- table(cd138_data$disease_stage, cd138_data$CD138)
print("Contingency Table (Original Values 0-3):")
print(cont_table_cd138_trend)

# Cochran-Armitage Trend Test (requires exactly 2 groups)
if(require(DescTools, quietly = TRUE) && nrow(cont_table_cd138_trend) >= 2 && ncol(cont_table_cd138_trend) >= 2) {
  available_stages <- rownames(cont_table_cd138_trend)

  # Test 1: Local vs mCRPC
  if("Local" %in% available_stages && "mCRPC" %in% available_stages) {
    cont_table_local_mcrpc <- cont_table_cd138_trend[c("Local", "mCRPC"), , drop = FALSE]
    tryCatch({
      ca_test_local_mcrpc <- CochranArmitageTest(cont_table_local_mcrpc, alternative = "one.sided")
      cat("\nCochran-Armitage Trend Test - Local vs mCRPC (CD138):\n")
      cat("p-value:", format.pval(ca_test_local_mcrpc$p.value, digits = 3), "\n")
      cat("Test statistic:", round(ca_test_local_mcrpc$statistic, 3), "\n")
    }, error = function(e) {
      cat("\nCochran-Armitage test (Local vs mCRPC) failed for CD138:", e$message, "\n")
    })
  }

  # Test 2: mHSPC vs mCRPC (if mHSPC exists)
  if("mHSPC" %in% available_stages && "mCRPC" %in% available_stages) {
    cont_table_mhspc_mcrpc <- cont_table_cd138_trend[c("mHSPC", "mCRPC"), , drop = FALSE]
    tryCatch({
      ca_test_mhspc_mcrpc <- CochranArmitageTest(cont_table_mhspc_mcrpc, alternative = "one.sided")
      cat("\nCochran-Armitage Trend Test - mHSPC vs mCRPC (CD138):\n")
      cat("p-value:", format.pval(ca_test_mhspc_mcrpc$p.value, digits = 3), "\n")
      cat("Test statistic:", round(ca_test_mhspc_mcrpc$statistic, 3), "\n")
    }, error = function(e) {
      cat("\nCochran-Armitage test (mHSPC vs mCRPC) failed for CD138:", e$message, "\n")
    })
  }
}

# Test 1: Compare mCRPC vs Local for high expression
if("Local" %in% cd138_data$disease_stage && "mCRPC" %in% cd138_data$disease_stage) {
  mcrpc_local_data <- cd138_data %>% filter(disease_stage %in% c("Local", "mCRPC"))

  # Fisher's exact test
  local_mcrpc_table <- table(mcrpc_local_data$disease_stage, mcrpc_local_data$CD138_cat)
  if(all(local_mcrpc_table > 0)) {
    fisher_local <- fisher.test(local_mcrpc_table, alternative = "greater")
    cat("\nLocal vs mCRPC - Fisher's exact test:\n")
    cat("p-value:", format.pval(fisher_local$p.value, digits = 3), "\n")
    cat("Odds ratio:", round(fisher_local$estimate, 2), "\n")
    cat("95% CI:", round(fisher_local$conf.int[1], 2), "-", round(fisher_local$conf.int[2], 2), "\n")
  }

  # Proportion test for high expression
  local_high <- sum(mcrpc_local_data$CD138_high[mcrpc_local_data$disease_stage == "Local"])
  local_total <- sum(mcrpc_local_data$disease_stage == "Local")
  mcrpc_high <- sum(mcrpc_local_data$CD138_high[mcrpc_local_data$disease_stage == "mCRPC"])
  mcrpc_total <- sum(mcrpc_local_data$disease_stage == "mCRPC")

  prop_test_local <- prop.test(c(mcrpc_high, local_high), c(mcrpc_total, local_total),
                              alternative = "greater")
  cat("Proportion test (mCRPC > Local for high expression):\n")
  cat("p-value:", format.pval(prop_test_local$p.value, digits = 3), "\n")
  cat("mCRPC high expression: ", mcrpc_high, "/", mcrpc_total, " (",
      round(mcrpc_high/mcrpc_total*100, 1), "%)\n")
  cat("Local high expression: ", local_high, "/", local_total, " (",
      round(local_high/local_total*100, 1), "%)\n")
}

# Test 2: Compare mCRPC vs mHSPC for high expression (if mHSPC exists)
if("mHSPC" %in% cd138_data$disease_stage && "mCRPC" %in% cd138_data$disease_stage) {
  mcrpc_mhspc_data <- cd138_data %>% filter(disease_stage %in% c("mHSPC", "mCRPC"))

  # Fisher's exact test
  mhspc_mcrpc_table <- table(mcrpc_mhspc_data$disease_stage, mcrpc_mhspc_data$CD138_cat)
  if(all(mhspc_mcrpc_table > 0)) {
    fisher_mhspc <- fisher.test(mhspc_mcrpc_table, alternative = "greater")
    cat("\nmHSPC vs mCRPC - Fisher's exact test:\n")
    cat("p-value:", format.pval(fisher_mhspc$p.value, digits = 3), "\n")
    cat("Odds ratio:", round(fisher_mhspc$estimate, 2), "\n")
    cat("95% CI:", round(fisher_mhspc$conf.int[1], 2), "-", round(fisher_mhspc$conf.int[2], 2), "\n")
  }

  # Proportion test for high expression
  mhspc_high <- sum(mcrpc_mhspc_data$CD138_high[mcrpc_mhspc_data$disease_stage == "mHSPC"])
  mhspc_total <- sum(mcrpc_mhspc_data$disease_stage == "mHSPC")
  mcrpc_high_2 <- sum(mcrpc_mhspc_data$CD138_high[mcrpc_mhspc_data$disease_stage == "mCRPC"])
  mcrpc_total_2 <- sum(mcrpc_mhspc_data$disease_stage == "mCRPC")

  prop_test_mhspc <- prop.test(c(mcrpc_high_2, mhspc_high), c(mcrpc_total_2, mhspc_total),
                              alternative = "greater")
  cat("Proportion test (mCRPC > mHSPC for high expression):\n")
  cat("p-value:", format.pval(prop_test_mhspc$p.value, digits = 3), "\n")
  cat("mCRPC high expression: ", mcrpc_high_2, "/", mcrpc_total_2, " (",
      round(mcrpc_high_2/mcrpc_total_2*100, 1), "%)\n")
  cat("mHSPC high expression: ", mhspc_high, "/", mhspc_total, " (",
      round(mhspc_high/mhspc_total*100, 1), "%)\n")
}

# Create plot with statistical annotations
prop_data <- cd138_data %>%
  group_by(disease_stage, CD138_cat) %>%
  summarise(n = n(), .groups = 'drop') %>%
  group_by(disease_stage) %>%
  mutate(
    total = sum(n),
    proportion = n / total * 100
  ) %>%
  ungroup()

# Create sample size labels for top of bars
sample_size_data <- prop_data %>%
  group_by(disease_stage) %>%
  summarise(total = first(total), .groups = 'drop') %>%
  mutate(label = paste0("n=", total))

# Add significance annotations based on tests
significance_text <- ""
if(exists("prop_test_local") && exists("prop_test_mhspc")) {
  significance_text <- paste0("Local vs mCRPC: p = ", format.pval(prop_test_local$p.value, digits = 3),
                             "; mHSPC vs mCRPC: p = ", format.pval(prop_test_mhspc$p.value, digits = 3))
} else if(exists("prop_test_local")) {
  significance_text <- paste0("Local vs mCRPC: p = ", format.pval(prop_test_local$p.value, digits = 3))
} else if(exists("prop_test_mhspc")) {
  significance_text <- paste0("mHSPC vs mCRPC: p = ", format.pval(prop_test_mhspc$p.value, digits = 3))
}

p3 <- ggplot(prop_data, aes(x = disease_stage, y = proportion, fill = CD138_cat)) +
  geom_col(position = "stack", alpha = 0.8) +
  scale_fill_manual(
    values = c("Low (0-2)" = "#95a5a6", "High (3)" = "#f39c12"),
    name = "CD138 Level"
  ) +
  labs(
    title = "CD138 Expression Categories",
    subtitle = paste0("Categorical analysis (Low: 0-2, High: 3)\n", significance_text),
    x = "Disease Stage",
    y = "Percentage (%)",
    fill = "CD138 Category"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    strip.text = element_text(size = 12, face = "bold"),
    legend.position = "bottom"
  ) +
  geom_text(aes(label = paste0(round(proportion, 1), "%")),
            position = position_stack(vjust = 0.5),
            color = "white", fontweight = "bold", size = 3) +
  geom_text(data = sample_size_data,
            aes(x = disease_stage, y = 105, label = label),
            inherit.aes = FALSE,
            size = 3.5, fontface = "bold", color = "black")

print(p3)

# Save CD138 results
cd138_results <- data.frame(
  Test = character(),
  P_value = numeric(),
  Odds_Ratio = numeric(),
  mCRPC_High_Pct = numeric(),
  Other_High_Pct = numeric(),
  stringsAsFactors = FALSE
)

if(exists("prop_test_local")) {
  cd138_results <- rbind(cd138_results, data.frame(
    Test = "Local_vs_mCRPC",
    P_value = prop_test_local$p.value,
    Odds_Ratio = ifelse(exists("fisher_local"), fisher_local$estimate, NA),
    mCRPC_High_Pct = mcrpc_high/mcrpc_total*100,
    Other_High_Pct = local_high/local_total*100
  ))
}

if(exists("prop_test_mhspc")) {
  cd138_results <- rbind(cd138_results, data.frame(
    Test = "mHSPC_vs_mCRPC",
    P_value = prop_test_mhspc$p.value,
    Odds_Ratio = ifelse(exists("fisher_mhspc"), fisher_mhspc$estimate, NA),
    mCRPC_High_Pct = mcrpc_high_2/mcrpc_total_2*100,
    Other_High_Pct = mhspc_high/mhspc_total*100
  ))
}

print("=== CD138 Results Summary ===")
print(cd138_results)

# Save CD138 results to file
write.csv(cd138_results,
          file.path(wd$outCurr, "CD138_mCRPC_high_expression_tests.csv"),
          row.names = FALSE)
```

## Combined Results Summary

```{r}
# Combine results from both markers
combined_marker_results <- data.frame(
  Marker = character(),
  Test = character(),
  P_value = numeric(),
  Odds_Ratio = numeric(),
  mCRPC_High_Pct = numeric(),
  Other_High_Pct = numeric(),
  stringsAsFactors = FALSE
)

# Add CD138 results
if(exists("cd138_results") && nrow(cd138_results) > 0) {
  combined_marker_results <- rbind(combined_marker_results,
                                  cbind(Marker = "CD138", cd138_results))
}

# Add GDF15 results
if(exists("gdf15_results") && nrow(gdf15_results) > 0) {
  combined_marker_results <- rbind(combined_marker_results,
                                  cbind(Marker = "GDF15", gdf15_results))
}

cat("=== COMBINED RESULTS: CD138 & GDF15 High Expression in mCRPC ===\n")
print(combined_marker_results)

# Save combined results
write.csv(combined_marker_results,
          file.path(wd$outCurr, "Combined_CD138_GDF15_mCRPC_high_expression_tests.csv"),
          row.names = FALSE)

# Save GDF15 results separately too
if(exists("gdf15_results")) {
  write.csv(gdf15_results,
            file.path(wd$outCurr, "GDF15_mCRPC_high_expression_tests.csv"),
            row.names = FALSE)
}

cat("\nFiles saved:\n")
cat("- CD138 results:", file.path(wd$outCurr, "CD138_mCRPC_high_expression_tests.csv"), "\n")
cat("- GDF15 results:", file.path(wd$outCurr, "GDF15_mCRPC_high_expression_tests.csv"), "\n")
cat("- Combined results:", file.path(wd$outCurr, "Combined_CD138_GDF15_mCRPC_high_expression_tests.csv"), "\n")
```


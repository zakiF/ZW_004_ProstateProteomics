---
title: "Initial analysis"
date: "2023-04-12"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: true
    toc_depth: 3
    number_sections: true
    theme: lumen
---

# Background

We cleaned the clinical files metadata. Now we analze the NPX data generated. For now focus on the non-serial samples. 

# Objectives



# Pre-processing 

## Loading packages

```{r, message=FALSE, warning=FALSE}
library(here)
library(tidyverse)
library(readxl)   
library(readr)
library(stringr)

library(tidyverse)
library(ggplot2)
library(ggrepel)
library(gghighlight)
library(ggbeeswarm)


library(OlinkAnalyze) # install.packages("OlinkAnalyze")
library(paletteer)
```


## Directories

```{r}
wd <- list()
wd$main <- here()
wd$data <- file.path(wd$main, "data")
wd$manishData <- file.path(wd$data, "raw/data_fromManish")
wd$d2024 <- file.path(wd$data, "updated_2024")
wd$d2024_npx <- file.path(wd$d2024, "NPX_data")
wd$output <- file.path(wd$main, "output")
wd$script <- file.path(wd$main, "scripts")

wd$outData <- file.path(wd$output, "data")
wd$outCurr <- file.path(wd$output, "02_Proteomics")

t.testDir <- file.path(wd$outCurr , "t_test")
dir.create(t.testDir)
```


Create directories

```{r}
if (!file.exists(wd$outCurr)) {
  dir.create(wd$outCurr)
} else {
  print("Directory already exists")
}
```

Load functions

```{r}
source(file.path(wd$script, "functions.R"))

theme_custom <- 
  theme_bw() +
  theme(panel.grid = element_blank())
```



## Load data

Load the processed metadata file

```{r}
#df_meta <- read.csv(file.path(wd$outData, "metadata.csv"))
```

# Objective 1

Read the NPX data 

Samples are listed in the `SampleID` column

```{r}
# # Psomagen
# dat_NPX <- readxl::read_excel(file.path(wd$d2024_npx, "batch_01_E3072_AN00003660_AN00003661_NPX_2022-04-21-columns.xlsx"))
# 
# # Olink Q-13356
# dat_NPX2 <- readr::read_delim(file.path(wd$d2024_npx, "batch_02_Q-13356_Kohli_EXTENDED_NPX_2024-03-11.csv"), delim = ";")
```

Remember that Q-13356 had duplicated samples. We need to remove one of them

## Global overview

We analyse each dataset first

### Psomagen

Select samples where we have clinical data.

```{r}
df_meta <- df_meta_f %>% 
  filter(!is.na(sample_id_psom)) %>% 
  # remove serial samples
  filter(serial_sample == 1) %>% 
  dplyr::rename(SampleID = sample_id_psom) %>% 
  select(cohort, SampleID) %>% 
  distinct() %>% 
  mutate(SampleID = as.character(SampleID))

# This removes control samples as well
dat1_NPX_anno <- dat_NPX %>%
  mutate(SampleID = as.character(SampleID)) %>% 
  dplyr::left_join(df_meta) %>%
  filter(!is.na(cohort))
```

Quick PCA 

```{r}
p_pca <-
  dat1_NPX_anno %>% 
  filter(!str_detect(SampleID, 'CS')) %>% 
  olink_pca_plot(df = .,
                 color_g = "cohort", byPanel = FALSE, quiet = FALSE) 


pca_cor <- p_pca[[1]]$data %>%
  rename(PC1 = PCX,
         PC2 = PCY) %>% 
  #Combine with master annotation
  left_join(df_meta)


ggplot(pca_cor, aes(x=PC1, y=PC2, colour=cohort)) +
  geom_point(size=2.5) +
  ylab(p_pca[[1]]$labels$y) +
  xlab(p_pca[[1]]$labels$x) +
  theme_classic() +
  theme(legend.position = "right",
        panel.grid.major = element_line(linetype = "blank"), 
        panel.grid.minor = element_line(linetype = "blank")) +
  scale_colour_manual(values=pal.cohort) +
  NULL
```

### Q-13356

Select samples where we have clinical data.

```{r}
df_meta2 <- df_meta_f %>% 
  filter(!is.na(sample_id_Q13356)) %>% 
  # remove serial samples
  filter(!HCI_cID %in% serial_sam) %>% 
  dplyr::rename(SampleID = sample_id_Q13356) %>% 
  select(cohort, SampleID) %>% 
  distinct() %>% 
  mutate(SampleID = as.character(SampleID))

# This removes conttol samples as well
dat2_NPX_anno <- dat_NPX2 %>%
  mutate(SampleID = as.character(SampleID)) %>% 
  dplyr::left_join(df_meta2) %>%
  filter(!is.na(cohort))
```

Run PCA

```{r}
p_pca2 <-
  dat2_NPX_anno %>% 
  filter(!str_detect(SampleID, 'CS')) %>% 
  olink_pca_plot(df = .,
                 color_g = "cohort", byPanel = FALSE, quiet = FALSE) 


pca_cor2 <- p_pca2[[1]]$data %>%
  rename(PC1 = PCX,
         PC2 = PCY) %>% 
  #Combine with master annotation
  left_join(df_meta2) %>% 
  mutate(dupe = if_else(SampleID %in% c(34,78), "Y", "N"))
  


ggplot(pca_cor2, aes(x=PC1, y=PC2, colour=cohort)) +
  geom_point(size=2.5) +
  ylab(p_pca2[[1]]$labels$y) +
  xlab(p_pca2[[1]]$labels$x) +
  theme_classic() +
  theme(legend.position = "right",
        panel.grid.major = element_line(linetype = "blank"), 
        panel.grid.minor = element_line(linetype = "blank")) +
  scale_colour_manual(values=pal.cohort[2:3]) +
  NULL

```

Plot the supposed duplicates

```{r}
ggplot(pca_cor2, aes(x=PC1, y=PC2, colour=dupe, label=SampleID)) +
  geom_point(size=2.5) +
  geom_text_repel() +
  ylab(p_pca2[[1]]$labels$y) +
  xlab(p_pca2[[1]]$labels$x) +
  theme_classic() +
  theme(legend.position = "right",
        panel.grid.major = element_line(linetype = "blank"), 
        panel.grid.minor = element_line(linetype = "blank")) +
  scale_color_manual(values=c("grey50", "red")) +
  NULL
```
### Q-15806

Select samples where we have clinical data.

```{r}
df_meta3 <- df_meta_f %>% 
  filter(!is.na(sample_id_Q15806)) %>% 
  # remove serial samples
  filter(!HCI_cID %in% serial_sam) %>% 
  dplyr::rename(SampleID = sample_id_Q15806) %>% 
  select(cohort, SampleID) %>% 
  distinct() %>% 
  mutate(SampleID = as.character(SampleID))

# This removes conttol samples as well
dat3_NPX_anno <- dat_NPX3 %>%
  mutate(SampleID = as.character(SampleID)) %>% 
  dplyr::left_join(df_meta3) %>%
  filter(!is.na(cohort))
```

Run PCA

```{r}
p_pca3 <-
  dat3_NPX_anno %>% 
  filter(!str_detect(SampleID, 'CS')) %>% 
  olink_pca_plot(df = .,
                 color_g = "cohort", byPanel = FALSE, quiet = FALSE) 


pca_cor3 <- p_pca3[[1]]$data %>%
  rename(PC1 = PCX,
         PC2 = PCY) %>% 
  #Combine with master annotation
  left_join(df_meta3)
  


ggplot(pca_cor3, aes(x=PC1, y=PC2, colour=cohort)) +
  geom_point(size=2.5) +
  ylab(p_pca2[[1]]$labels$y) +
  xlab(p_pca2[[1]]$labels$x) +
  theme_classic() +
  theme(legend.position = "right",
        panel.grid.major = element_line(linetype = "blank"), 
        panel.grid.minor = element_line(linetype = "blank")) +
  scale_colour_manual(values=pal.cohort) +
  NULL

```


## Protein overlap

What is the protein overlap in the Psomagen and Q-1335?

Check the overlap using OlinkID 

```{r}
id_pso <- dat1_NPX_anno %>% pull(OlinkID) %>% unique()
id_q1335 <- dat2_NPX_anno %>% filter(!str_detect(Assay, "control")) %>%  pull(OlinkID) %>% unique()
id_q158 <- dat3_NPX_anno %>% filter(!str_detect(Assay, "control")) %>%  pull(OlinkID) %>% unique()

overlap <- calculate.overlap(
x <- list("Psomagen"=id_pso, 
          "Q-1335"=id_q1335,
          "Q-15806"=id_q158
          ))

ggvenn(
  x, 
  fill_color = pal.study,
  stroke_size = 0.5, set_name_size = 4
  )


# Protein names
id_pso <- dat1_NPX_anno %>% pull(Assay) %>% unique()
id_q1335 <- dat2_NPX_anno %>%  filter(!str_detect(Assay, "control")) %>% pull(Assay) %>% unique()
id_q158 <- dat3_NPX_anno %>%  filter(!str_detect(Assay, "control")) %>% pull(Assay) %>% unique()

overlap <- calculate.overlap(
x <- list("Psomagen"=id_pso, 
          "Q-1335"=id_q1335,
          "Q-15806"=id_q158
          ))

ggvenn(
  x, 
  fill_color = pal.study,
  stroke_size = 0.5, set_name_size = 4
  )
```

Make a table of proteins and OlinkIDs

```{r}
d1 <- dat1_NPX_anno %>% select(OlinkID, Assay) %>% distinct() %>% 
  mutate(ID_assay = paste(OlinkID, Assay, sep="_"))
d2 <- dat2_NPX_anno %>% filter(!str_detect(Assay, "control")) %>% select(OlinkID, Assay) %>% distinct() %>% 
  mutate(ID_assay = paste(OlinkID, Assay, sep="_"))

d_all <- rbind(d1,d2) %>% distinct()


d_all <- d_all %>% 
  mutate(inPsom = if_else(ID_assay %in% d1$ID_assay, "Y", "N"),
         inQ1335 = if_else(ID_assay %in% d2$ID_assay, "Y", "N"))

write.csv(d_all, file.path(wd$outCurr, "Proteins_overlap.csv"))

```

We note there are three proteins with mis-match annotation, lets correct this

```{r}
d_all <- d_all %>% 
  mutate(
    Assay = case_when(
      OlinkID == "OID20125" ~ "NT-proBNP",
      OlinkID == "OID20857" ~ "CERT1",
      OlinkID == "OID21084" ~ "WARS1",
      TRUE ~ Assay))
  
# Create a list of Olink paired with protein ID
df_id_pro <- d_all %>% select(OlinkID, Assay) %>% distinct()
```

The previous venn tells us that the protein present in the panel. But we want to know what percentage of the proteins are considered expressing. 


```{r}
numSample1 <- length(unique(dat1_NPX_anno$SampleID))
  
dat1_missing <- dat1_NPX_anno %>% 
  group_by(OlinkID) %>% 
  summarise(PercMissing = (sum(NPX < LOD) / numSample1) * 100) %>% 
  mutate(Group = "Psomagen")

numSample2 <- length(unique(dat2_NPX_anno$SampleID))
  
dat2_missing <- dat2_NPX_anno %>% 
  filter(!str_detect(Assay, "control")) %>% 
  group_by(OlinkID) %>% 
  summarise(PercMissing = (sum(NPX < LOD) / numSample2) * 100) %>% 
  # If its NA, it is 100 missing
  mutate(PercMissing = case_when(is.na(PercMissing) ~ 100,
                                 TRUE ~ PercMissing),
         Group = "Q-1335")
  
numSample3 <- length(unique(dat3_NPX_anno$SampleID))
  
dat3_missing <- dat3_NPX_anno %>% 
  filter(!str_detect(Assay, "control")) %>% 
  group_by(OlinkID) %>% 
  summarise(PercMissing = (sum(NPX < LOD) / numSample2) * 100) %>% 
  # If its NA, it is 100 missing
  mutate(PercMissing = case_when(is.na(PercMissing) ~ 100,
                                 TRUE ~ PercMissing),
         Group = "Q-1580")

# Number of proteins missing 100%
df_plot <- rbind(dat1_missing, dat2_missing, dat3_missing)

df_mis <- df_plot %>% filter(PercMissing >= 50) %>% 
  group_by(Group) %>% 
  summarise(TotalMis = n())
df_mis
```

Are these missing proteins the same?

```{r}
perc_mis <- 100
m1 <- df_plot %>% filter(Group == "Psomagen" & PercMissing >= perc_mis) %>% pull(OlinkID)
m2 <- df_plot %>% filter(Group == "Q-1335" & PercMissing >= perc_mis) %>% pull(OlinkID)
m3 <- df_plot %>% filter(Group == "Q-1580" & PercMissing >= perc_mis) %>% pull(OlinkID)

overlap <- calculate.overlap(
x <- list("Psomagen"=m1, 
          "Q-1335"=m2,
          "Q-15806"=m3
          ))

ggvenn(
  x, 
  fill_color = pal.study,
  stroke_size = 0.5, set_name_size = 4
  )
```

Make a side-by side plot of missingness

```{r}
ggplot(df_plot, aes(x=Group, y=PercMissing, fill=Group)) +
    geom_quasirandom(dodge.width=0.9, colour="grey30", alpha=0.5) +
  scale_fill_manual(values=pal.study) +
  geom_violin(alpha = 0.5, scale = "width", position = position_dodge(width = 0.9)) +
  geom_boxplot(outlier.alpha = 0,  width = 0.2, coef=0,
               position = position_dodge(width = 0.9),
               alpha = 0.2) +
  theme_bw() +
  theme(legend.position = "none",
        panel.grid.major = element_line(linetype = "blank"), 
        panel.grid.minor = element_line(linetype = "blank"),
        axis.text.x = element_text(angle = 0)) +
  NULL
```


# Bridging

Lets do bridging analysis. We follow the workflow on Olink website - https://cran.r-project.org/web//packages/OlinkAnalyze/vignettes/bridging_introduction.html


The bridging analysis only works with 2 dataset. Because we want to bridge between 3 datasets, we need to do the bridging twice. 

## Psomagen + Q-13356


We first need to rename the samples to ensure the bridged samples have the same matching ID.

```{r}
dat <- df_meta_f
xx1 <- dat1_NPX_anno
xx2 <- dat2_NPX_anno

# Rename the Q1335 bridge samples to Psomagen name
dat_sub <- filter(dat, isBridge == "Y") %>% 
  mutate(sample_id_psom = paste0("Ps_", sample_id_psom)) %>% 
  select(sample_id_Q13356, sample_id_psom) %>% distinct() %>% 
  dplyr::rename(SampleID = sample_id_Q13356) %>% 
  mutate(SampleID = as.character(SampleID))

xx2 <- xx2 %>% left_join(dat_sub)

xx2 <- xx2 %>% 
  mutate(SampleID = case_when(
    SampleID %in% dat_sub$SampleID ~ sample_id_psom,
    TRUE ~ SampleID
  ))
           
           
# Renames Psomagen to include "Ps_"
xx1 <- xx1 %>% mutate(SampleID = paste0("Ps_", SampleID))

```

Now lets find the overlapping samples

```{r}
overlap_samples <- data.frame(SampleID = intersect(xx1$SampleID, xx2$SampleID)) %>%
  filter(!str_detect(SampleID, "CONTROL_SAMPLE")) %>% #Remove control samples
  pull(SampleID)

overlap_samples_list <- list("DF1" = overlap_samples,
                             "DF2" = overlap_samples)

xx1.1 <- xx1 #%>% select(SampleID, OlinkID, UniProt, NPX, Panel, cohort)
xx2.1 <- xx2 #%>% select(SampleID, OlinkID, UniProt, NPX, Panel, cohort)


# Perform Bridging normalization
npx_br_data <- olink_normalization_bridge(project_1_df = xx1.1,
                                          project_2_df = xx2.1,
                                          bridge_samples = overlap_samples_list,
                                          project_1_name = "Psomagen",
                                          project_2_name = "Q1335",
                                          project_ref_name = "Psomagen")
```

Another way to do bridging without renaming the samples

```{r}
xx1 <- dat1_NPX_anno
xx2 <- dat2_NPX_anno

xx1 <- xx1 %>% 
  mutate(SampleID = paste0("Ps_", SampleID))

xx2 <- xx2 %>% 
  mutate(SampleID = paste0("Q1335Q_", SampleID),)

# Identify bridging samples
dat_sub <- filter(dat, isBridge == "Y") %>% 
  mutate(sample_id_psom = paste0("Ps_", sample_id_psom),
         sample_id_Q13356 = paste0("Q1335Q_", sample_id_Q13356),)


overlap_sample_list <-list("DF1" = dat_sub$sample_id_psom,
                           "DF2" = dat_sub$sample_id_Q13356)

xx1.1 <- xx1 #%>% select(SampleID, OlinkID, UniProt, NPX, Panel, cohort)
xx2.1 <- xx2 #%>% select(SampleID, OlinkID, UniProt, NPX, Panel, cohort)


# Perform Bridging normalization
npx_br_data <- olink_normalization(
  df1 = xx1.1,
  df2 = xx2.1,
  overlapping_samples_df1 = dat_sub$sample_id_psom,
  overlapping_samples_df2 = dat_sub$sample_id_Q13356,
  df1_project_nr = "data1",
  df2_project_nr = "data2",
  reference_project = "data1")
```

Both method give the same result

Quick PCA analysis

```{r}
# After bridging analysis  
npx_after_br <- npx_br_data %>%
  dplyr::mutate(Type = ifelse(SampleID %in% as.character(unlist(overlap_sample_list)), 
                              paste0(Project, "_Bridge"),
                              paste0(Project, "_Sample"))) %>%
  dplyr:::mutate(SampleID = paste0(Project, SampleID))

### PCA plot seperated by cohort
p_pca_bridge1 <-
  npx_after_br %>% 
  filter(!str_detect(SampleID, 'CS')) %>% 
  olink_pca_plot(df = .,
                 color_g = "cohort", byPanel = FALSE, quiet = FALSE) 
```


Show the bridging samples

```{r}
# Generate a matching sample matrix
# Read matching samples
mat_sam <- data.frame(
  SampleID = c(dat_sub$sample_id_psom, dat_sub$sample_id_Q13356),
  Matching = as.character(1:nrow(dat_sub))
)

# Extract PCA coordinate
pca_cor_b <- p_pca_bridge1[[1]]$data %>%
  rename(PC1 = PCX,
         PC2 = PCY) %>%
  mutate(Batch = gsub("data1.*", "Psomagen", SampleID),
         Batch = gsub("data2.*", "Q1335", Batch),
         SampleID = gsub("data1", "", SampleID),
         SampleID = gsub("data2", "", SampleID)) %>% 
  # Combine with master annotation
  left_join(mat_sam)

```

```{r}
p2 <- 
  ggplot(pca_cor_b, aes(x=PC1, y=PC2, colour=Batch)) +
  geom_point() +
  gghighlight(use_direct_label = FALSE) +
  theme(legend.position = "right") +
  facet_wrap(~Matching) +
  theme_custom +
  #scale_colour_manual(values=pal.study) + 
  labs(title="Highlighting the Sequencing batch")
p2
```


Plot the cohort

```{r}
ggplot(pca_cor_b, aes(x=PC1, y=PC2, colour=colors)) +
  geom_point(size=2.5) +
  ylab(p_pca_bridge1[[1]]$labels$y) +
  xlab(p_pca_bridge1[[1]]$labels$x) +
  theme_classic() +
  theme(legend.position = "right",
        panel.grid.major = element_line(linetype = "blank"), 
        panel.grid.minor = element_line(linetype = "blank")) +
  scale_colour_manual(values=pal.cohort) +
  NULL
```

## Psomagen + Q-15806

Repeat for 2nd set of data

```{r}
xx1 <- dat1_NPX_anno
xx2 <- dat3_NPX_anno

xx1 <- xx1 %>% 
  mutate(SampleID = paste0("Ps_", SampleID))

xx2 <- xx2 %>% 
  mutate(SampleID = paste0("Q1580Q_", SampleID),)

# Identify bridging samples
dat_sub <- filter(dat, isBridge == "Y") %>% 
  mutate(sample_id_psom = paste0("Ps_", sample_id_psom),
         sample_id_Q15806 = paste0("Q1580Q_", sample_id_Q15806))


overlap_sample_list <-list("DF1" = dat_sub$sample_id_psom,
                           "DF2" = dat_sub$sample_id_Q15806)

xx1.1 <- xx1 %>% select(SampleID, OlinkID, UniProt, NPX, Panel, cohort)
xx2.1 <- xx2 %>% select(SampleID, OlinkID, UniProt, NPX, Panel, cohort)


# Perform Bridging normalization
px_br_data2 <- olink_normalization(
  df1 = xx1.1,
  df2 = xx2.1,
  overlapping_samples_df1 = dat_sub$sample_id_psom,
  overlapping_samples_df2 = dat_sub$sample_id_Q15806,
  df1_project_nr = "data1",
  df2_project_nr = "data2",
  reference_project = "data1")
```

Quick PCA plot

```{r}
npx_after_br2 <- px_br_data2 %>%
  dplyr::mutate(Type = ifelse(SampleID %in% as.character(unlist(overlap_sample_list)), 
                              paste0(Project, "_Bridge"),
                              paste0(Project, "_Sample"))) %>%
  dplyr:::mutate(SampleID = paste0(Project, SampleID))

### PCA plot
p_pca_bridge2 <-
  npx_after_br2 %>% 
  filter(!str_detect(SampleID, 'CS')) %>% 
  olink_pca_plot(df = .,
                 color_g = "cohort", byPanel = FALSE, quiet = FALSE) 
```


Show the bridging samples

```{r}
# Generate a matching sample matrix
# Read matching samples
mat_sam <- data.frame(
  SampleID = c(dat_sub$sample_id_psom, dat_sub$sample_id_Q15806),
  Matching = as.character(1:nrow(dat_sub))
)

# Extract PCA coordinate
pca_cor_b2 <- p_pca_bridge2[[1]]$data %>%
  rename(PC1 = PCX,
         PC2 = PCY) %>%
  mutate(Batch = gsub("data1.*", "Psomagen", SampleID),
         Batch = gsub("data2.*", "Q1580Q", Batch),
         SampleID = gsub("data1", "", SampleID),
         SampleID = gsub("data2", "", SampleID)) %>% 
  # Combine with master annotation
  left_join(mat_sam)

```

Re-plot the cohort with appropriate colour scale

```{r}
ggplot(pca_cor_b2, aes(x=PC1, y=PC2, colour=colors)) +
  geom_point(size=2.5) +
  ylab(p_pca_bridge2[[1]]$labels$y) +
  xlab(p_pca_bridge2[[1]]$labels$x) +
  theme_classic() +
  theme(legend.position = "right",
        panel.grid.major = element_line(linetype = "blank"), 
        panel.grid.minor = element_line(linetype = "blank")) +
  scale_colour_manual(values=pal.cohort) +
  NULL
```

Plot the bridging samples


```{r}
p2.2 <- 
  ggplot(pca_cor_b2, aes(x=PC1, y=PC2, colour=Batch)) +
  geom_point() +
  gghighlight(use_direct_label = FALSE) +
  theme(legend.position = "right") +
  facet_wrap(~Matching) +
  theme_custom +
  #scale_colour_manual(values=pal.study) + 
  labs(title="Highlighting the Sequencing batch")
p2.2
```


## Final analysis

Here we bridge across 3 cohorts, We simply combine the bridged NPX values. 


```{r}
b1 <- npx_after_br 
b2 <- npx_after_br2 %>% filter(!Project == "data1") %>% 
  mutate(Project = gsub("data2", "data3", Project),
         SampleID = gsub("data2", "data3", SampleID))
npx_all <- rbind(b1, b2)
```

Run PCA

```{r}
### PCA plot
p_pca_bridge_all <-
  npx_all %>% 
  filter(!str_detect(SampleID, 'CS')) %>% 
  olink_pca_plot(df = .,
                 color_g = "cohort", byPanel = FALSE, quiet = FALSE) 
```

Show the bridging samples

```{r}
# Identify bridging samples
dat_sub <- filter(dat, isBridge == "Y") %>% 
  mutate(sample_id_psom = paste0("Ps_", sample_id_psom),
         sample_id_Q13356 = paste0("Q1335Q_", sample_id_Q13356),
         sample_id_Q15806 = paste0("Q1580Q_", sample_id_Q15806)
         )

# Generate a matching sample matrix
# Read matching samples
mat_sam <- data.frame(
  SampleID = c(dat_sub$sample_id_psom, dat_sub$sample_id_Q13356, dat_sub$sample_id_Q15806),
  Matching = as.character(1:nrow(dat_sub))
)

# Extract PCA coordinate
pca_cor_b_all <- p_pca_bridge_all[[1]]$data %>%
  rename(PC1 = PCX,
         PC2 = PCY) %>%
  mutate(Batch = gsub("data1.*", "Psomagen", SampleID),
         Batch = gsub("data2.*", "Q1335", Batch),
         Batch = gsub("data3.*", "Q1580", Batch),
         SampleID = gsub("data1", "", SampleID),
         SampleID = gsub("data2", "", SampleID),
         SampleID = gsub("data3", "", SampleID),
         ) %>% 
  # Combine with master annotation
  left_join(mat_sam)

```

```{r}
p2_all <- 
  ggplot(pca_cor_b_all, aes(x=PC1, y=PC2, colour=Batch)) +
  geom_point() +
  gghighlight(use_direct_label = FALSE) +
  theme(legend.position = "right") +
  facet_wrap(~Matching) +
  theme_custom +
  #scale_colour_manual(values=pal.study) + 
  labs(title="Highlighting the Sequencing batch")
p2_all
```

Plot the cohort

```{r}
ggplot(pca_cor_b_all, aes(x=PC1, y=PC2, colour=colors)) +
  geom_point(size=2.5) +
  ylab(p_pca_bridge_all[[1]]$labels$y) +
  xlab(p_pca_bridge_all[[1]]$labels$x) +
  theme_classic() +
  theme(legend.position = "right",
        panel.grid.major = element_line(linetype = "blank"), 
        panel.grid.minor = element_line(linetype = "blank")) +
  scale_colour_manual(values=pal.cohort) +
  NULL
```
Show the cohort IDs

```{r}
ggplot(pca_cor_b_all, aes(x=PC1, y=PC2, colour=colors, label=SampleID)) +
  geom_point(size=2.5) +
  ylab(p_pca_bridge_all[[1]]$labels$y) +
  xlab(p_pca_bridge_all[[1]]$labels$x) +
  theme_classic() +
  theme(legend.position = "right",
        panel.grid.major = element_line(linetype = "blank"), 
        panel.grid.minor = element_line(linetype = "blank")) +
  scale_colour_manual(values=pal.cohort) +
  geom_text_repel() +
  NULL
```


Plot based on groups in each cohort

```{r}
ggplot(pca_cor_b_all, aes(x=PC1, y=PC2, colour=Batch)) +
  geom_point(size=2) +
  gghighlight(use_direct_label = FALSE) +
  theme(legend.position = "right") +
  facet_wrap(~colors) +
  theme_custom +
  scale_colour_manual(values=pal.study) + 
  labs(title="Highlighting the cohort")

ggplot(pca_cor_b_all, aes(x=PC1, y=PC2, colour=colors)) +
  geom_point(size=2) +
  gghighlight(use_direct_label = FALSE) +
  theme(legend.position = "right") +
  facet_wrap(~Batch) +
  theme_custom +
  scale_colour_manual(values=pal.cohort) + 
  labs(title="Highlighting the Sequencing batch")
```

### Sample number

Final number of samples, excluding the duplicated sampels

```{r}
df_samp <- pca_cor_b_all %>% 
  filter(!SampleID %in% dat_sub$sample_id_psom)
table(df_samp$colors)
```


## Alternate analysis

If we did exclude the outlier, how will it look. 


```{r,FALSE}
p_pca4 <- 
  npx_after_br %>% 
  mutate(SampleID = gsub("data1", "", SampleID),
         SampleID = gsub("data2", "", SampleID)) %>% 
  filter(!str_detect(SampleID, 'CS')) %>% 
  filter(!SampleID %in% c("Ps_134", "Ps_45", "Ps_161", "Ps_88", "Ps_46",
                          "Q1335Q_45", "Q1335Q_54", "Q1335Q_77", "Q1335Q_59", "Q1335Q_9", "Q1335Q_76")) %>% 
  olink_pca_plot(df = .,
                 color_g = "cohort", byPanel = FALSE, quiet = FALSE) 



# Extract PCA coordinate
p_pca4 <- p_pca4[[1]]$data %>%
  rename(PC1 = PCX,
         PC2 = PCY) %>%
  mutate(Batch = gsub("data1.*", "Psomagen", SampleID),
         Batch = gsub("data2.*", "Q1335", Batch),
         SampleID = gsub("data1", "", SampleID),
         SampleID = gsub("data2", "", SampleID))

kk <- p_pca4 %>% 
  rename(sample_id = SampleID) %>% 
  left_join(meta_bridge)



ggplot(kk, aes(x=PC1, y=PC2, colour=OS)) +
  geom_point(size=2.5) +
  ylab(p_pca2[[1]]$labels$y) +
  xlab(p_pca2[[1]]$labels$x) +
  theme_classic() +
  theme(legend.position = "right",
        panel.grid.major = element_line(linetype = "blank"), 
        panel.grid.minor = element_line(linetype = "blank")) +
  scale_colour_viridis_c() +
  NULL

```

